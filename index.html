<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorador Neo-Riemanniano</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js (Audio) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* Estilos Base */
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; color: #1f2937; margin: 0; padding: 1rem; }
        .container { max-width: 1600px; margin: 0 auto; background: transparent; }
        
        /* Layout Grid Principal */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (min-width: 1280px) {
            .dashboard-grid {
                grid-template-columns: 3fr 1fr; /* M√°s espacio para visualizaciones */
            }
        }

        /* Grid de Visualizaciones (Simult√°neas) */
        .viz-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            height: 100%;
        }
        
        @media (min-width: 1024px) {
            .viz-grid {
                grid-template-columns: 1fr 1fr; /* Lado a lado */
            }
        }

        /* Paneles */
        .panel { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; overflow: hidden; display: flex; flex-direction: column; }
        .panel-header { background: #f9fafb; padding: 10px 15px; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #374151; display: flex; justify-content: space-between; align-items: center; }
        .panel-body { padding: 15px; flex-grow: 1; position: relative; }

        /* Utilidades */
        .hidden { display: none !important; }
        .show { opacity: 1 !important; visibility: visible !important; }
        
        /* Botones */
        .btn { padding: 8px 12px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; font-size: 0.9rem; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        .btn-secondary:hover { background-color: #e5e7eb; }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.7; }
        
        /* Botones de Operaci√≥n */
        .op-btn { height: 60px; font-size: 1.2rem; display: flex; flex-direction: column; justify-content: center; align-items: center; line-height: 1.1; }
        .op-btn span { font-size: 0.65rem; font-weight: normal; color: #555; text-align: center; }
        .op-btn strong { font-size: 1.1rem; }

        /* Componentes espec√≠ficos */
        .chord-display-main { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #bfdbfe; margin-bottom: 15px; }
        .history-container { max-height: 300px; overflow-y: auto; }
        .history-item { padding: 8px 10px; border-bottom: 1px solid #f3f4f6; cursor: pointer; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }
        .history-item:hover { background-color: #f9fafb; }
        .history-item:last-child { border-bottom: none; }
        .active-history { background-color: #eff6ff; border-left: 3px solid #3b82f6; }

        /* Visualizaciones */
        .circle-container { height: 400px; width: 100%; position: relative; display: flex; justify-content: center; align-items: center; }
        .tonnetz-container { height: 400px; width: 100%; overflow: hidden; background: #fafafa; border-radius: 8px; }
        .tonnetz-node-circle { transition: fill 0.3s ease; cursor: pointer; }
        .tonnetz-node-text { pointer-events: none; user-select: none; }

        /* Conducci√≥n de voces */
        .voice-leading-row { display: flex; justify-content: space-between; padding: 6px 4px; border-bottom: 1px solid #eee; font-family: monospace; font-size: 0.95rem; cursor: pointer; transition: background 0.2s; border-radius: 4px; }
        .voice-leading-row:hover { background-color: #f0fdf4; }
        .voice-leading-row:active { background-color: #dcfce7; }
        .voice-leading-row:last-child { border-bottom: none; }
        .common-tone { font-weight: bold; background-color: rgba(0,0,0,0.05); padding: 0 4px; border-radius: 4px; }
        
        /* Piano */
        .piano-container { width: 100%; height: 80px; margin-top: 15px; display: flex; justify-content: center; }
        .piano-key { fill: white; stroke: #333; stroke-width: 1px; transition: fill 0.1s; }
        .piano-key.black { fill: #333; stroke: black; }
        .piano-key.active { fill: #3b82f6 !important; }
        .piano-key.black.active { fill: #2563eb !important; }

        /* Quiz */
        .quiz-option-btn {
            background-color: #fff; border: 1px solid #e5e7eb; padding: 8px; 
            border-radius: 6px; cursor: pointer; text-align: center; font-size: 0.9rem;
            transition: all 0.1s;
        }
        .quiz-option-btn:hover { background-color: #f3f4f6; }
        .quiz-option-btn.correct { background-color: #dcfce7; border-color: #16a34a; color: #166534; font-weight: bold; }
        .quiz-option-btn.wrong { background-color: #fee2e2; border-color: #dc2626; color: #991b1b; }
        .quiz-feedback { font-weight: bold; margin-top: 5px; min-height: 20px; }

        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 36px; height: 20px; vertical-align: middle; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #3b82f6; }
        input:checked + .toggle-slider:before { transform: translateX(16px); }

        /* Top Bar Inputs */
        .top-bar-select { background: #f9fafb; border: 1px solid #d1d5db; padding: 6px 10px; border-radius: 6px; font-size: 0.9rem; }
        .top-bar-label { font-size: 0.8rem; font-weight: 600; color: #6b7280; margin-right: 5px; text-transform: uppercase; letter-spacing: 0.05em; }

        /* Modales */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 50; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 25px rgba(0,0,0,0.1); }
        .show { opacity: 1 !important; visibility: visible !important; }
        
        .tab-btn { padding: 8px 16px; border-bottom: 2px solid transparent; font-weight: 500; color: #6b7280; }
        .tab-btn.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 700; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header / Top Bar -->
        <header class="mb-4">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <span class="text-blue-600 text-3xl">‚ú¶</span> Explorador Neo-Riemanniano
                </h1>
            </div>

            <!-- Global Controls Bar -->
            <div id="startChordContainer" class="panel p-3 flex flex-wrap items-center gap-4 md:gap-6 bg-white shadow-sm flex-row">
                <!-- Selector Acorde -->
                <div class="flex items-center gap-2 flex-1 min-w-[200px]">
                    <span class="top-bar-label">Inicio:</span>
                    <select id="startChord" class="top-bar-select w-full max-w-[180px]"></select>
                </div>

                <!-- Enharmonic Toggle -->
                <div class="flex items-center gap-2 border-l border-gray-200 pl-4">
                    <span class="text-xs font-bold text-gray-500">‚ôØ</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="enharmonicToggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="text-xs font-bold text-gray-500">‚ô≠</span>
                </div>

                <!-- Sound Controls -->
                <div class="flex items-center gap-3 border-l border-gray-200 pl-4">
                    <div class="flex items-center gap-1">
                        <select id="waveTypeSelect" class="top-bar-select py-1 text-xs">
                            <option value="triangle">Tri√°ngulo</option>
                            <option value="sine">Senoidal</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-xs text-gray-500">Vol</span>
                        <input type="range" id="volumeSlider" min="-30" max="0" value="-10" class="w-20 accent-blue-600">
                    </div>
                    <button id="muteButton" class="btn btn-secondary py-1 px-2 text-sm" title="Silenciar (M)">üîä</button>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-2 border-l border-gray-200 pl-4 ml-auto">
                    <button id="resetButton" class="btn btn-secondary text-sm">‚Ü∫ Reiniciar</button>
                    <button id="glossaryButton" class="btn btn-secondary text-sm font-bold text-blue-600 border-blue-200 bg-blue-50">? Ayuda</button>
                </div>
            </div>

            <!-- Analysis Controls -->
            <div id="analysisControls" class="hidden panel p-4 bg-yellow-50 border-yellow-200 mb-4 flex-col">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-800 text-lg">An√°lisis: <span id="analysisTitle" class="text-blue-700"></span></h3>
                    <div class="text-xs text-gray-500">Usa las flechas ‚Üê ‚Üí para navegar</div>
                    <button id="exitAnalysisBtn" class="btn btn-secondary bg-white text-xs text-red-600 border-red-200 hover:bg-red-50">‚úï Salir (Esc)</button>
                </div>
                
                <div class="flex flex-col gap-4">
                    <!-- Contenedor de Imagen -->
                    <div class="w-full bg-white p-2 rounded shadow-sm border border-gray-200">
                        <div id="analysisScoreContainer" class="hidden text-center">
                            <img id="analysisScoreImage" src="" alt="Partitura" class="w-full h-auto object-contain max-h-[400px]">
                        </div>
                        <div id="analysisCitation" class="text-xs text-gray-500 italic mt-2 text-center"></div>
                    </div>
                    
                    <div class="w-full flex flex-col justify-between">
                        <div id="analysisExplanation" class="bg-white p-4 rounded border border-yellow-100 text-sm mb-3 shadow-sm"></div>
                        <div class="flex gap-2">
                            <button id="prevStepBtn" class="btn btn-secondary flex-1">‚Üê Anterior</button>
                            <button id="nextStepBtn" class="btn btn-primary flex-1">Siguiente ‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            
            <!-- Left Column: VISUALIZACIONES SIMULT√ÅNEAS -->
            <div class="viz-grid">
                
                <!-- Panel 1: C√≠rculo -->
                <div class="panel h-full">
                    <div class="panel-header">
                        <span>C√≠rculos de Transformaci√≥n</span>
                        <div class="text-xs flex items-center gap-2 font-normal">
                            <span>Ciclos L/P</span>
                            <label class="toggle-switch scale-75 origin-center">
                                <input type="checkbox" id="vizToggle">
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Regiones R/N</span>
                        </div>
                    </div>
                    
                    <div class="panel-body flex items-center justify-center bg-white flex-col">
                        <h3 id="circleTitle" class="text-sm font-bold text-gray-500 mb-2 absolute top-2 left-3">Ciclo Hexat√≥nico</h3>
                        <div id="hexatonicCircle" class="circle-container">
                            <svg width="100%" height="100%" viewBox="0 0 300 300"></svg>
                        </div>
                        <div class="mt-2 text-xs text-gray-500 text-center bg-gray-50 p-2 rounded w-full">
                            Ciclo Actual: <span id="currentHexatonicCycle" class="font-bold text-blue-600">-</span> <br>
                            Regi√≥n Weitzmann: <span id="currentWeitzmannRegion" class="font-bold text-indigo-600">-</span>
                        </div>
                    </div>
                </div>

                <!-- Panel 2: Tonnetz -->
                <div class="panel h-full">
                    <div class="panel-header">
                        <span>Tonnetz</span>
                        <span class="text-xs text-gray-400 font-normal">Click en nodos para fijar</span>
                    </div>
                    
                    <div class="panel-body p-0">
                        <div id="vizPaneTonnetz" class="w-full h-full">
                            <div id="tonnetzVisualization" class="tonnetz-container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Operations & Info -->
            <div class="flex flex-col gap-4 h-full">
                
                <!-- Current Chord -->
                <div class="panel">
                    <div class="panel-body">
                        <div class="chord-display-main">
                            <h2 class="text-2xl font-bold text-blue-800 mb-1"><span id="currentChordName">C Mayor</span></h2>
                            <p class="text-sm text-gray-500 mb-3 tracking-widest font-mono"><span id="currentChordNotes">C E G</span></p>
                            <div class="flex justify-center gap-2">
                                <button id="playChordButton" class="btn btn-primary text-xs py-1 px-3 shadow-md shadow-blue-200">‚ñ∂ Acorde (Espacio)</button>
                                <button id="playArpeggioButton" class="btn btn-secondary text-xs py-1 px-3">üéπ Arpegio (A)</button>
                            </div>
                            
                            <!-- Piano Keyboard -->
                            <div id="pianoContainer" class="piano-container"></div>
                        </div>
                        
                        <!-- Operations Grid -->
                        <div id="operationsBox">
                            <label class="text-xs font-bold text-gray-500 uppercase mb-2 block text-center">Transformaciones (Teclado)</label>
                            <div class="grid grid-cols-3 gap-2 mb-4">
                                <button class="btn btn-secondary op-btn relative" data-op="L"><strong>L</strong><span>Leading-Tone<br>(Sensible)</span></button>
                                <button class="btn btn-secondary op-btn relative" data-op="P"><strong>P</strong><span>Parallel<br>(Paralela)</span></button>
                                <button class="btn btn-secondary op-btn relative" data-op="R"><strong>R</strong><span>Relative<br>(Relativa)</span></button>
                                <button class="btn btn-secondary op-btn relative" data-op="N"><strong>N</strong><span>Neighbor<br>(Vecina)</span></button>
                                <button class="btn btn-secondary op-btn relative" data-op="S"><strong>S</strong><span>Slide<br>(Deslizar)</span></button>
                                <button class="btn btn-secondary op-btn relative" data-op="H"><strong>H</strong><span>Hex. Pole<br>(Polo)</span></button>
                            </div>
                        </div>
                        
                        <!-- Explanation Box -->
                        <div class="bg-blue-50 border border-blue-100 rounded-lg p-3">
                            <div id="explanationTitleContainer"></div>
                            <div id="operationExplanation" class="text-sm text-gray-700">
                                <p class="text-center text-gray-400 italic">Selecciona una operaci√≥n arriba para ver la conducci√≥n de voces.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tools Panel -->
                <div class="panel">
                    <div class="panel-header py-2 px-3 text-sm">Herramientas</div>
                    <div class="panel-body p-3 bg-gray-50">
                        <div class="mb-3 border-b pb-3">
                            <select id="analysisSelect" class="w-full p-2 border border-gray-300 rounded text-sm mb-2">
                                <option value="">üìÇ Cargar An√°lisis Guiado...</option>
                                <option value="liszt">Liszt - Consolaci√≥n IV</option>
                                <option value="schubert">Schubert - D.946 N¬∫2</option>
                            </select>
                            <div id="quizContainer" class="mt-2 bg-amber-50 p-2 rounded border border-amber-100 hidden">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-bold text-amber-700 text-sm">Modo Quiz</span>
                                    <button id="stopQuizBtn" class="text-xs text-gray-500 underline">Salir</button>
                                </div>
                                <p id="quizQuestion" class="text-sm mb-2 font-semibold text-center">¬øPregunta?</p>
                                <div id="quizOptions" class="grid grid-cols-2 gap-2 mb-2"></div>
                                <div id="quizFeedback" class="quiz-feedback text-xs text-center"></div>
                            </div>
                            <button id="startQuizBtn" class="btn btn-secondary w-full text-xs text-amber-700 border-amber-200 bg-amber-50 hover:bg-amber-100">üéì Iniciar Entrenamiento (Quiz)</button>
                        </div>
                        
                        <div id="freeAnalysisContainer">
                            <textarea id="freeAnalysisInput" rows="1" class="w-full p-2 border border-gray-300 rounded text-sm resize-none" placeholder="An√°lisis libre: C Am F..."></textarea>
                            <div class="flex justify-between items-center mt-2">
                                <p id="freeAnalysisError" class="text-red-600 text-xs"></p>
                                <button id="freeAnalysisButton" class="btn btn-primary text-xs py-1">Analizar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History -->
                <div class="panel flex-grow h-[300px]">
                    <div class="panel-header py-2 px-3 text-sm">Historial de Movimientos</div>
                    <div id="historyLog" class="history-container bg-white flex-grow">
                        <div class="p-4 text-center text-gray-400 text-xs italic">El historial aparecer√° aqu√≠</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="credits mt-8 text-center text-xs text-gray-400">
            Realizado por: <strong>Juan Miguel R√≠os Redondo</strong>
        </div>
    </div>

    <!-- Modal Ayuda -->
    <div id="glossaryModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-blue-700 mb-4 text-center">Ayuda y Conceptos</h2>
            <div class="bg-gray-100 p-3 rounded mb-4 text-sm text-center">
                <strong>Atajos de Teclado:</strong><br>
                Teclas <span class="font-mono bg-white px-1 rounded">L</span> <span class="font-mono bg-white px-1 rounded">P</span> <span class="font-mono bg-white px-1 rounded">R</span> <span class="font-mono bg-white px-1 rounded">N</span> <span class="font-mono bg-white px-1 rounded">S</span> <span class="font-mono bg-white px-1 rounded">H</span> para Operaciones<br>
                <span class="font-mono bg-white px-1 rounded">Espacio</span> Reproducir | <span class="font-mono bg-white px-1 rounded">A</span> Arpegio | <span class="font-mono bg-white px-1 rounded">M</span> Silencio<br>
                <span class="font-mono bg-white px-1 rounded">‚Üê</span> <span class="font-mono bg-white px-1 rounded">‚Üí</span> Navegar An√°lisis | <span class="font-mono bg-white px-1 rounded">Esc</span> Salir
            </div>
            <div class="flex border-b mb-4">
                <button class="tab-btn active w-1/2" data-tab="operaciones">Operaciones</button>
                <button class="tab-btn w-1/2" data-tab="conceptos">Conceptos Te√≥ricos</button>
            </div>
            
            <div id="tabOperaciones" class="tab-pane active h-[350px] overflow-y-auto pr-2">
                <div class="space-y-4 text-sm">
                    <div class="border-b pb-2">
                        <strong class="text-lg text-blue-600">P (Parallel / Paralela)</strong>
                        <p class="mt-1">Relaciona una tr√≠ada mayor con su menor paralela (y viceversa). Misma fundamental.<br>
                        <em>Ejemplo: C Mayor ‚Üî C menor.</em></p>
                    </div>
                    <div class="border-b pb-2">
                        <strong class="text-lg text-blue-600">L (Leading-Tone / Sensible)</strong>
                        <p class="mt-1">Intercambio de sensible. Se conserva la tercera mayor (o menor) y la quinta (o fundamental) se mueve medio tono.<br>
                        <em>Ejemplo: C Mayor ‚Üî E menor.</em></p>
                    </div>
                    <div class="border-b pb-2">
                        <strong class="text-lg text-blue-600">R (Relative / Relativa)</strong>
                        <p class="mt-1">Relaciona una tr√≠ada con su relativa diat√≥nica.<br>
                        <em>Ejemplo: C Mayor ‚Üî A menor.</em></p>
                    </div>
                    <div class="border-b pb-2">
                        <strong class="text-lg text-blue-600">N (Neighbor / Vecina)</strong>
                        <p class="mt-1">Relaciona una tr√≠ada con su subdominante menor (desde mayor) o dominante mayor (desde menor). Equivale a aplicar R, luego L, luego P.<br>
                        <em>Ejemplo: C Mayor ‚Üî F menor.</em></p>
                    </div>
                    <div class="border-b pb-2">
                        <strong class="text-lg text-blue-600">S (Slide / Deslizamiento)</strong>
                        <p class="mt-1">Dos tr√≠adas que comparten la tercera, pero cambian de modo (invirtiendo fundamental y quinta). Equivale a LPR.<br>
                        <em>Ejemplo: C Mayor ‚Üî C# menor.</em></p>
                    </div>
                    <div>
                        <strong class="text-lg text-blue-600">H (Hexatonic Pole / Polo)</strong>
                        <p class="mt-1">Relaciona una tr√≠ada con su "polo opuesto" en el ciclo hexat√≥nico. Equivale a LPL (o PLP). Genera un cromatismo oscuro e intenso.<br>
                        <em>Ejemplo: C Mayor ‚Üî Ab menor.</em></p>
                    </div>
                </div>
            </div>
            
            <div id="tabConceptos" class="tab-pane h-[350px] overflow-y-auto pr-2">
                <div class="space-y-4 text-sm">
                    <div>
                        <strong class="text-blue-600">Tonnetz (Red Tonal)</strong>
                        <p class="mt-1">El Tonnetz es una ret√≠cula geom√©trica que mapea el espacio de tonos. Los nodos son notas individuales. Los tri√°ngulos conectan tres notas formando tr√≠adas. Este mapa permite visualizar la "distancia" arm√≥nica no en funci√≥n de la tonalidad cl√°sica (c√≠rculo de quintas), sino en funci√≥n de la conducci√≥n de voces suave (parsimonia).</p>
                        <ul class="list-disc pl-5 mt-2 text-gray-500 text-xs">
                            <li>Movimiento horizontal: Quintas justas.</li>
                            <li>Diagonales (‚Üó): Terceras menores.</li>
                            <li>Diagonales (‚Üò): Terceras mayores.</li>
                        </ul>
                    </div>
                    <div>
                        <strong class="text-blue-600">Conducci√≥n Parsimoniosa</strong>
                        <p class="mt-1">Es el principio central de la teor√≠a Neo-Riemanniana. Sugiere que las progresiones arm√≥nicas m√°s "naturales" o fluidas en este sistema son aquellas que maximizan las notas comunes y minimizan el movimiento de las voces restantes (idealmente por semitonos o tonos enteros).</p>
                    </div>
                    <div>
                        <strong class="text-blue-600">Ciclo Hexat√≥nico</strong>
                        <p class="mt-1">Una cadena cerrada de 6 acordes conectados alternando operaciones L y P. Por ejemplo: C - Em - E - C#m - Ab - Abm - C. Estos acordes comparten un set de 6 notas (la escala hexat√≥nica) y orbitan alrededor de un centro tonal ambiguo, creando un efecto de suspensi√≥n o "flotaci√≥n" arm√≥nica t√≠pico del romanticismo tard√≠o.</p>
                    </div>
                     <div>
                        <strong class="text-blue-600">Regiones de Weitzmann</strong>
                        <p class="mt-1">Similar a los ciclos hexat√≥nicos, pero generados por operaciones R y N. Definen regiones arm√≥nicas relacionadas por terceras menores y relaciones de vecindad.</p>
                    </div>
                </div>
            </div>
            <button id="closeGlossaryButton" class="btn btn-primary w-full mt-6">Cerrar</button>
        </div>
    </div>

    <!-- Modal Autor -->
    <div id="authorModal" class="modal-overlay">
         <div class="modal-content text-center max-w-sm">
            <h2 class="text-xl font-bold text-blue-700 mb-2">¬°Bienvenido!</h2>
            <p class="text-gray-600">Explorador de Teor√≠a Neo-Riemanniana</p>
            <div class="animate-pulse mt-4 text-blue-500">Iniciando motor de audio...</div>
        </div>
    </div>

    <script>
        // --- LOGICA DE LA APLICACI√ìN ---
        
        let currentTriad, previousTriad = null, history = [], currentHistoryIndex = -1;
        let hexatonicCycles = [], weitzmannCycles = [];
        let currentVisualizationMode = 'lp', isInAnalysisMode = false, currentAnalysis = null, currentAnalysisStep = 0;
        let enharmonicPreference = 'sharp';
        let isToneStarted = false, isMuted = false, lastPlayedVoicing = [], currentTonnetzHighlight = null;
        
        // Quiz State
        let isQuizMode = false, quizTargetTriadName = null;

        // Visual Assets
        const voiceColors = ['#dc2626', '#16a34a', '#2563eb']; // Red, Green, Blue for Voice 0, 1, 2

        const synth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" }, envelope: { attack: 0.05, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
        const arpeggioSynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.05, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();

        const noteToPitchClass = { "C":0, "C‚ôØ":1, "D‚ô≠":1, "D":2, "D‚ôØ":3, "E‚ô≠":3, "E":4, "F":5, "F‚ôØ":6, "G‚ô≠":6, "G":7, "G‚ôØ":8, "A‚ô≠":8, "A":9, "A‚ôØ":10, "B‚ô≠":10, "B":11, "E‚ôØ":5, "B‚ôØ":0, "C‚ô≠":11, "F‚ô≠":4, "Gx":9, "Ax":11 };
        const canonicalSpelling = {
            sharp: { 0:"C", 1:"C‚ôØ", 2:"D", 3:"D‚ôØ", 4:"E", 5:"F", 6:"F‚ôØ", 7:"G", 8:"G‚ôØ", 9:"A", 10:"A‚ôØ", 11:"B" },
            flat:  { 0:"C", 1:"D‚ô≠", 2:"D", 3:"E‚ô≠", 4:"E", 5:"F", 6:"G‚ô≠", 7:"G", 8:"A‚ô≠", 9:"A", 10:"B‚ô≠", 11:"B" }
        };
        const allPossibleRootNames = ["C", "C‚ôØ", "D‚ô≠", "D", "D‚ôØ", "E‚ô≠", "E", "F", "F‚ôØ", "G‚ô≠", "G", "G‚ôØ", "A‚ô≠", "A", "A‚ôØ", "B‚ô≠", "B"];
        const rootNamesByPreference = {
            sharp: ["C", "C‚ôØ", "D", "D‚ôØ", "E", "F", "F‚ôØ", "G", "G‚ôØ", "A", "A‚ôØ", "B"],
            flat:  ["C", "D‚ô≠", "D", "E‚ô≠", "E", "F", "G‚ô≠", "G", "A‚ô≠", "A", "B‚ô≠", "B"]
        };

        const citationText = "Calabrese, A. (2025). Armon√≠a de los Siglos XIX al XXI: Claves para navegar el espacio crom√°tico. Omb√∫ Ediciones Musicales.";
        const analysisData = {
            'liszt': { 
                name: "Liszt - Consolaci√≥n IV", 
                imageUrl: "https://github.com/juanmiguel0927/TeoriaNeo-Riemanniana/raw/237988f08d9cfcc051ba15127077478eb15c7828/Liszt.png", 
                citation: citationText,
                steps: [ { chord: 'B‚ô≠ menor', op: null, text: "Comp√°s 20. Inicio en Si‚ô≠m." }, { chord: 'D‚ô≠ Mayor', op: 'R', text: "Comp√°s 21. B‚ô≠m ‚Üí D‚ô≠M." }, { chord: 'D‚ô≠ menor', op: 'P', text: "Comp√°s 21. D‚ô≠M ‚Üí D‚ô≠m." }, { chord: 'E Mayor', op: 'R', text: "Comp√°s 22. D‚ô≠m ‚Üí EM." }, { chord: 'E menor', op: 'P', text: "Comp√°s 22. EM ‚Üí Em." }, { chord: 'G menor', op: null, text: "Comp√°s 23. Em ‚Üí Gm." } ] 
            },
            'schubert': { 
                name: "Schubert - D.946 N¬∫2", 
                imageUrl: "https://raw.githubusercontent.com/juanmiguel0927/TeoriaNeo-Riemanniana/237988f08d9cfcc051ba15127077478eb15c7828/Schubert.png", 
                citation: citationText,
                steps: [ { chord: 'D menor', op: null, text: "Comp√°s 46. Inicio en Dm." }, { chord: 'A Mayor', op: 'N', text: "Comp√°s 48. Dm ‚Üí AM." }, { chord: 'F menor', op: 'H', text: "Comp√°s 49. AM ‚Üí Fm." }, { chord: 'C Mayor', op: 'N', text: "Comp√°s 51. Fm ‚Üí CM." }, { chord: 'A‚ô≠ menor', op: 'H', text: "Comp√°s 52. CM ‚Üí A‚ô≠m." } ] 
            }
        };

        const tonnetzNodesData = [
            { note: "D‚ôØ", pc: 3, x: 0, y: 0 }, { note: "A‚ôØ", pc: 10, x: 80, y: 0 }, { note: "E‚ôØ", pc: 5, x: 160, y: 0 }, { note: "B‚ôØ", pc: 0, x: 240, y: 0 }, { note: "Gx", pc: 9, x: 320, y: 0 },
            { note: "B", pc: 11, x: -40, y: 75 }, { note: "F‚ôØ", pc: 6, x: 40, y: 75 }, { note: "C‚ôØ", pc: 1, x: 120, y: 75 }, { note: "G‚ôØ", pc: 8, x: 200, y: 75 }, { note: "D‚ôØ", pc: 3, x: 280, y: 75 }, { note: "A‚ôØ", pc: 10, x: 360, y: 75 },
            { note: "D", pc: 2, x: 0, y: 150 }, { note: "A", pc: 9, x: 80, y: 150 }, { note: "E", pc: 4, x: 160, y: 150 }, { note: "B", pc: 11, x: 240, y: 150 }, { note: "F‚ôØ", pc: 6, x: 320, y: 150 }, { note: "C‚ôØ", pc: 1, x: 400, y: 150 },
            { note: "B‚ô≠", pc: 10, x: -40, y: 225 }, { note: "F", pc: 5, x: 40, y: 225 }, { note: "C", pc: 0, x: 120, y: 225 }, { note: "G", pc: 7, x: 200, y: 225 }, { note: "D", pc: 2, x: 280, y: 225 }, { note: "A", pc: 9, x: 360, y: 225 },
            { note: "D‚ô≠", pc: 1, x: 0, y: 300 }, { note: "A‚ô≠", pc: 8, x: 80, y: 300 }, { note: "E‚ô≠", pc: 3, x: 160, y: 300 }, { note: "B‚ô≠", pc: 10, x: 240, y: 300 }, { note: "F", pc: 5, x: 320, y: 300 }, { note: "C", pc: 0, x: 400, y: 300 },
            { note: "F‚ô≠", pc: 4, x: 40, y: 375 }, { note: "C‚ô≠", pc: 11, x: 120, y: 375 }, { note: "G‚ô≠", pc: 6, x: 200, y: 375 }, { note: "D‚ô≠", pc: 1, x: 280, y: 375 }, { note: "A‚ô≠", pc: 8, x: 360, y: 375 },
            { note: "B", pc: 11, x: -40, y: 375 }, { note: "E", pc: 4, x: 40, y: 375 }
        ];

        function normalizePitch(pc) { return (pc % 12 + 12) % 12; }
        function getNoteNameFromMidi(midi, pref = enharmonicPreference) { return canonicalSpelling[pref][normalizePitch(midi)] + (Math.floor(midi/12)-1); }
        function getElement(id) { return document.getElementById(id); }
        function safeClassListRemove(id, cls) { const el = getElement(id); if(el) el.classList.remove(cls); }
        function safeClassListAdd(id, cls) { const el = getElement(id); if(el) el.classList.add(cls); }

        class Triad {
            constructor(root, type) { this.root = root; this.type = type; this.pitchClasses = this.calcPC(); this.name = `${root} ${type === 'major' ? 'Mayor' : 'menor'}`; }
            calcPC() { const r = noteToPitchClass[this.root]; return (this.type==='major'?[r, normalizePitch(r+4), normalizePitch(r+7)]:[r, normalizePitch(r+3), normalizePitch(r+7)]).sort((a,b)=>a-b); }
            getNotes() { const r=noteToPitchClass[this.root]; const t=(this.type==='major')?normalizePitch(r+4):normalizePitch(r+3); const f=normalizePitch(r+7); const s=(pc)=>canonicalSpelling[enharmonicPreference][pc]; return [this.root, s(t), s(f)]; }
            hasSamePitchClasses(o) { return this.pitchClasses.every((p,i)=>p===o.pitchClasses[i]); }
        }

        function generateAllTriads() { allTriads = []; const added = new Set(); allPossibleRootNames.forEach(r => { ["major", "minor"].forEach(t => { const tr = new Triad(r, t); if(!added.has(tr.name)){ allTriads.push(tr); added.add(tr.name); } }) }); }
        function getTriadByName(n) { if(!n)return null; let nm = n.trim().replace(/b/g,'‚ô≠').replace(/#/g,'‚ôØ'); let type = (nm.toLowerCase().includes("m") && !nm.includes("Mayor")) ? "minor" : "major"; nm = nm.replace(/menor|major|mayor|m/gi, '').trim(); let r = nm.charAt(0).toUpperCase() + nm.slice(1); return allTriads.find(t=>t.name===`${r} ${type==='major'?'Mayor':'menor'}`); }
        function getPreferredSpelling(t) { if(!t)return null; const r = noteToPitchClass[t.root]; const pr = canonicalSpelling[enharmonicPreference][r]; return allTriads.find(x=>x.root===pr && x.type===t.type)||t; }
        function findTriadByPitchClasses(pcs, type) { const s = [...pcs].sort((a,b)=>a-b); return allTriads.find(t=>t.type===type && t.pitchClasses.every((p,i)=>p===s[i])) || null; }

        function opL(t) { const r = noteToPitchClass[t.root]; return t.type==='major' ? findTriadByPitchClasses([normalizePitch(r+4),normalizePitch(r+7),normalizePitch(r-1)], 'minor') : findTriadByPitchClasses([normalizePitch(r+7+1),r,normalizePitch(r+3)], 'major'); }
        function opP(t) { const r = noteToPitchClass[t.root]; return t.type==='major' ? findTriadByPitchClasses([r,normalizePitch(r+3),normalizePitch(r+7)], 'minor') : findTriadByPitchClasses([r,normalizePitch(r+4),normalizePitch(r+7)], 'major'); }
        function opR(t) { const r = noteToPitchClass[t.root]; return t.type==='major' ? findTriadByPitchClasses([normalizePitch(r-3),r,normalizePitch(r+4)], 'minor') : findTriadByPitchClasses([normalizePitch(r+3),normalizePitch(r+7),normalizePitch(r+10)], 'major'); }
        function opN(t) { const r = noteToPitchClass[t.root]; return t.type==='major' ? findTriadByPitchClasses([normalizePitch(r+5),normalizePitch(r+8),r], 'minor') : findTriadByPitchClasses([normalizePitch(r+7),normalizePitch(r-1),normalizePitch(r+2)], 'major'); }
        function opH(t) { let p=opP(t); if(!p)return null; let l=opL(p); if(!l)return null; return opP(l); }
        function opS(t) { let r=opR(t); if(!r)return null; let n=opN(r); if(!n)return null; return opR(n); }
        
        function findOperationPath(startTriad, targetTriad) {
            const queue = [{triad: startTriad, path: []}];
            const visited = new Set([startTriad.name]);
            const maxDepth = 4;
            while(queue.length > 0) {
                const {triad, path} = queue.shift();
                if(triad.hasSamePitchClasses(targetTriad) && triad.type === targetTriad.type) return path.join("");
                if(path.length >= maxDepth) continue;
                const ops = [['L', opL], ['P', opP], ['R', opR]];
                for(let [name, func] of ops) {
                    const nextT = func(triad);
                    if(nextT && !visited.has(nextT.name)) {
                        visited.add(nextT.name);
                        queue.push({triad: nextT, path: [...path, name]});
                    }
                }
            }
            return null; 
        }
        
        function findBestOperation(a, b) { 
            if(opP(a)&&opP(a).hasSamePitchClasses(b)) return 'P'; 
            if(opL(a)&&opL(a).hasSamePitchClasses(b)) return 'L'; 
            if(opR(a)&&opR(a).hasSamePitchClasses(b)) return 'R'; 
            if(opN(a)&&opN(a).hasSamePitchClasses(b)) return 'N'; 
            if(opS(a)&&opS(a).hasSamePitchClasses(b)) return 'S'; 
            if(opH(a)&&opH(a).hasSamePitchClasses(b)) return 'H'; 
            const path = findOperationPath(a, b);
            return path || '??'; 
        }

        function genCycles() {
            const start = canonicalSpelling[enharmonicPreference];
            hexatonicCycles = []; weitzmannCycles = [];
            [0,1,2,3].forEach(i => {
                let c = [], curr = getTriadByName(`${start[i]} Mayor`);
                for(let k=0;k<6;k++) { if(curr) c.push(curr); curr=(k%2===0)?opL(curr):opP(curr); }
                hexatonicCycles.push({name: `Ciclo ${i+1}`, members: c.filter(Boolean)});
                c = []; curr = getTriadByName(`${start[i]} Mayor`);
                for(let k=0;k<6;k++) { if(curr) c.push(curr); curr=(k%2===0)?opR(curr):opN(curr); }
                weitzmannCycles.push({name: `Regi√≥n ${i+1}`, members: c.filter(Boolean)});
            });
        }
        function getHexatonicCycleForTriad(triad) { if (!triad) return null; return hexatonicCycles.find(cycle => cycle.members.some(member => member.hasSamePitchClasses(triad) && member.type === triad.type)); }
        function getWeitzmannRegionForTriad(triad) { if (!triad) return null; return weitzmannCycles.find(cycle => cycle.members.some(member => member.hasSamePitchClasses(triad) && member.type === triad.type)); }

        // --- GESTI√ìN DE AN√ÅLISIS ---
        function exitAnalysis() {
            isInAnalysisMode = false; currentAnalysis = null;
            const sel = getElement("analysisSelect"); if(sel) sel.value = "";
            safeClassListAdd("analysisControls", "hidden");
            safeClassListRemove("startChordContainer", "hidden");
            safeClassListRemove("operationsBox", "hidden");
            safeClassListRemove("freeAnalysisContainer", "hidden");
            history = []; currentHistoryIndex = -1; updateHistoryLog();
        }
        function startAnalysis(key) {
            isInAnalysisMode = true; currentAnalysis = analysisData[key]; currentAnalysisStep = 0;
            const t = getElement("analysisTitle"); if(t) t.textContent = currentAnalysis.name;
            const cit = getElement("analysisCitation"); if(cit) cit.textContent = currentAnalysis.citation || "";
            const img = getElement("analysisScoreImage"); const cont = getElement("analysisScoreContainer");
            if(img && cont) { 
                if(currentAnalysis.imageUrl) { img.src = currentAnalysis.imageUrl; cont.classList.remove('hidden'); } 
                else { cont.classList.add('hidden'); } 
            }
            safeClassListRemove("analysisControls", "hidden");
            safeClassListAdd("startChordContainer", "hidden");
            safeClassListAdd("operationsBox", "hidden"); 
            safeClassListAdd("freeAnalysisContainer", "hidden");
            loadAnalysisStep(0);
        }
        function loadAnalysisStep(idx) {
            if (!currentAnalysis || idx < 0 || idx >= currentAnalysis.steps.length) return;
            currentAnalysisStep = idx;
            const step = currentAnalysis.steps[idx];
            const newTriad = getPreferredSpelling(getTriadByName(step.chord));
            const prevStep = (idx > 0) ? currentAnalysis.steps[idx - 1] : null;
            const oldTriad = prevStep ? getPreferredSpelling(getTriadByName(prevStep.chord)) : null;
            previousTriad = oldTriad; currentTriad = newTriad;
            startAudioContext();
            let fMidi, tMidi;
            if (oldTriad) {
                fMidi = lastPlayedVoicing.map(n => Tone.Frequency(n).toMidi());
                tMidi = getSmartVoicing(fMidi, newTriad);
                updateVoicing(tMidi);
            } else {
                tMidi = newTriad.getNotes().map(n => Tone.Frequency(n.replace('‚ôØ','#').replace('‚ô≠','b')+"4").toMidi());
                fMidi = tMidi; updateVoicing(tMidi);
            }
            updateUI();
            displayOperationExplanation(step.op || "Siguiente", oldTriad, newTriad, fMidi, tMidi);
            const desc = getElement("operationExplanation");
            if(desc) desc.innerHTML = `<p class="mb-2 font-bold text-blue-800">${step.text}</p>` + desc.innerHTML;
            if (idx > 0) addHistoryEntry(step.op || "Siguiente", oldTriad, newTriad, fMidi, tMidi); else { history=[]; currentHistoryIndex=-1; updateHistoryLog(); }
            const prevBtn = getElement("prevStepBtn"); if(prevBtn) prevBtn.disabled = (idx === 0);
            const nextBtn = getElement("nextStepBtn"); if(nextBtn) nextBtn.disabled = (idx === currentAnalysis.steps.length - 1);
        }

        // --- CORE UI ---
        function setStartChord(name, preserve) {
            if(!preserve) exitAnalysis();
            currentTriad = getPreferredSpelling(getTriadByName(name) || allTriads[0]);
            if(!preserve) { history=[]; currentHistoryIndex=-1; previousTriad=null; updateVoicing(currentTriad.getNotes().map(n=>Tone.Frequency(n.replace('‚ôØ','#').replace('‚ô≠','b')+"4").toMidi())); }
            updateUI(); if(!preserve) displayOperationExplanation('');
            safeClassListRemove("operationsBox", "operations-box-active");
        }
        async function startAudioContext() { if(!isToneStarted){ await Tone.start(); isToneStarted=true; } }
        function updateVoicing(m) { lastPlayedVoicing = m.map(x=>Tone.Frequency(x,"midi").toNote()); }
        
        function playProgression(fromMidi, toMidi) {
            if(isMuted) return;
            startAudioContext();
            const now = Tone.now();
            const notes1 = fromMidi.map(m => Tone.Frequency(m, "midi").toNote());
            
            // Visuals synced with audio
            highlightKeys(fromMidi);
            synth.triggerAttackRelease(notes1, "2n", now);
            
            const notes2 = toMidi.map(m => Tone.Frequency(m, "midi").toNote());
            // Delay visual update for second chord approx 1s (2n at 120bpm)
            setTimeout(() => highlightKeys(toMidi), 1000);
            synth.triggerAttackRelease(notes2, "1n", now + 1);
        }
        
        function playVoicing(m) { 
            if(isMuted)return; startAudioContext(); updateVoicing(m); synth.triggerAttackRelease(lastPlayedVoicing, "1s"); 
            highlightKeys(m);
        }
        function playArpeggio(m) { 
            if(isMuted)return; startAudioContext(); 
            highlightKeys(m);
            [...m].sort((a,b)=>a-b).map(x=>Tone.Frequency(x,"midi").toNote()).forEach((n,i)=>arpeggioSynth.triggerAttackRelease(n, "8n", Tone.now()+i*0.15)); 
        }
        
        function playVoiceLeading(midiFrom, midiTo) {
             if(isMuted) return;
             startAudioContext();
             const n1 = Tone.Frequency(midiFrom, "midi").toNote();
             const n2 = Tone.Frequency(midiTo, "midi").toNote();
             const now = Tone.now();
             highlightKeys([midiFrom]);
             arpeggioSynth.triggerAttackRelease(n1, "8n", now);
             setTimeout(() => highlightKeys([midiTo]), 300);
             arpeggioSynth.triggerAttackRelease(n2, "4n", now + 0.3);
        }

        // Improved Voice Leading Logic
        function getSmartVoicing(fromMidi, toTriad) {
            const targetPcs = toTriad.pitchClasses; 
            let newVoicing = new Array(fromMidi.length).fill(null);
            let availableTargetPcs = [...targetPcs];
            
            for(let i=0; i < fromMidi.length; i++) {
                const currentPc = fromMidi[i] % 12;
                if(availableTargetPcs.includes(currentPc)) {
                    newVoicing[i] = fromMidi[i]; 
                    const idx = availableTargetPcs.indexOf(currentPc);
                    if(idx > -1) availableTargetPcs.splice(idx, 1);
                }
            }
            
            for(let i=0; i < newVoicing.length; i++) {
                if(newVoicing[i] === null) {
                    const startNote = fromMidi[i];
                    let bestMidi = -1;
                    let minDist = Infinity;
                    
                    for(let j=0; j < availableTargetPcs.length; j++) {
                        const targetPc = availableTargetPcs[j];
                        const currentOctaveBase = Math.floor(startNote / 12) * 12;
                        const candidates = [currentOctaveBase + targetPc, currentOctaveBase + targetPc + 12, currentOctaveBase + targetPc - 12];
                        for(let cand of candidates) {
                            const dist = Math.abs(cand - startNote);
                            if(dist < minDist) { minDist = dist; bestMidi = cand; }
                        }
                    }
                    newVoicing[i] = bestMidi;
                    const usedPc = bestMidi % 12;
                    const idx = availableTargetPcs.indexOf(usedPc);
                    if(idx > -1) availableTargetPcs.splice(idx, 1);
                }
            }
            return newVoicing;
        }

        function getClosestVoicing(f, t) { return getSmartVoicing(f, t); }

        function updateUI() {
            if(!currentTriad) return;
            currentTriad = getPreferredSpelling(currentTriad);
            const notes = currentTriad.getNotes(), pcs = currentTriad.pitchClasses;
            const nm = getElement("currentChordName"); if(nm) nm.textContent = currentTriad.name;
            const cn = getElement("currentChordNotes");
            if(cn) cn.innerHTML = notes.join(" - ");
            updateHistoryLog(); updateSetRelationshipsDisplay(); updateCircleVisualization(currentTriad, previousTriad); drawFullTonnetz(); highlightTonnetzTriad(currentTriad, previousTriad);
            highlightKeys(lastPlayedVoicing.map(n => Tone.Frequency(n).toMidi()));
        }
        function updateHistoryLog() {
            const log = getElement("historyLog"); if(!log) return; log.innerHTML = "";
            if(history.length === 0) {
                 log.innerHTML = '<div class="p-4 text-center text-gray-400 text-xs italic">El historial aparecer√° aqu√≠</div>';
                 return;
            }
            [...history].reverse().forEach((h, i) => {
                const div = document.createElement("div");
                div.className = `history-item ${history.length-1-i===currentHistoryIndex?'active-history':''}`;
                const fT = getPreferredSpelling(getTriadByName(h.from)); const tT = getPreferredSpelling(getTriadByName(h.to));
                div.innerHTML = `<span>${fT?fT.name:h.from} <span class="text-blue-500 font-bold">‚Üí</span> ${tT?tT.name:h.to}</span> <span class="text-xs bg-gray-200 px-1 rounded">${h.operation}</span>`;
                div.onclick = () => { 
                    if(isInAnalysisMode) { loadAnalysisStep((history.length - 1 - i) + 1); } 
                    else { 
                        currentHistoryIndex = history.length-1-i; 
                        currentTriad = getTriadByName(h.to); 
                        const tMidi = h.toMidi;
                        const fMidi = h.fromMidi;
                        updateVoicing(tMidi); 
                        updateUI(); 
                        displayOperationExplanation(h.operation, getTriadByName(h.from), currentTriad, fMidi, tMidi); 
                        playProgression(fMidi, tMidi); 
                    }
                };
                log.appendChild(div);
            });
        }
        function displayOperationExplanation(op, from, to, fMidi, tMidi) {
            const opDefinitions = { "L": "Leading-Tone (Sensible)", "P": "Parallel (Paralela)", "R": "Relative (Relativa)", "N": "Neighbor (Vecina)", "H": "Hexatonic Pole (Polo)", "S": "Slide (Deslizamiento)" };
            const opName = opDefinitions[op] || op;
            
            let html = op ? `<strong class="text-blue-600 block mb-2 text-center text-base border-b pb-2">Operaci√≥n: ${opName}</strong>` : "Selecciona una operaci√≥n.";
            
            if(from && to && fMidi && tMidi) {
                html += `<div class="mt-2 text-xs"><strong>Conducci√≥n de Voces:</strong><br><span class="text-gray-400 text-[10px] block mb-1 font-normal">(Haz clic en una fila para escuchar)</span><div class="flex flex-col gap-1 mt-1 bg-white p-2 rounded border border-gray-100">`;
                
                for(let i=0; i<fMidi.length; i++) {
                     const fm = fMidi[i];
                     const tm = tMidi[i];
                     const isCommon = (fm % 12) === (tm % 12);
                     const noteNameFrom = getNoteNameFromMidi(fm);
                     const noteNameTo = getNoteNameFromMidi(tm);
                     const voiceColor = voiceColors[i % voiceColors.length];
                     
                     html += `
                    <div class="voice-leading-row" style="color:${voiceColor}" onclick="window.playVoiceLeading(${fm}, ${tm})" title="Reproducir movimiento: ${noteNameFrom} -> ${noteNameTo}">
                        <span class="${isCommon ? 'common-tone' : ''} w-1/3 text-right">${noteNameFrom}</span>
                        <span class="text-gray-400 w-1/6 text-center">‚Üí</span>
                        <span class="${isCommon ? 'common-tone' : ''} w-1/3 text-left">${noteNameTo}</span>
                        <span class="w-1/6 text-xs text-gray-500 text-right flex items-center justify-end">${isCommon ? 'Com√∫n' : 'üîä'}</span>
                    </div>`;
                }
                html += `</div></div>`;
            }
            const opEl = getElement('operationExplanation'); if(opEl) opEl.innerHTML = html;
        }
        function addHistoryEntry(op, from, to, fMidi, tMidi) { if(currentHistoryIndex < history.length - 1) history = history.slice(0, currentHistoryIndex + 1); history.push({operation: op, from: from.name, to: to.name, fromMidi: fMidi, toMidi: tMidi}); currentHistoryIndex = history.length - 1; updateHistoryLog(); }
        function updateSetRelationshipsDisplay() {
             const hex = getHexatonicCycleForTriad(currentTriad); const wei = getWeitzmannRegionForTriad(currentTriad);
             const hexEl = getElement("currentHexatonicCycle"); if(hexEl) hexEl.textContent = hex ? hex.name : "-";
             const weiEl = getElement("currentWeitzmannRegion"); if(weiEl) weiEl.textContent = wei ? wei.name : "-";
        }
        function populateStartChordSelect() {
            const sel = document.getElementById("startChord"); if(!sel) return;
            sel.innerHTML = ''; const added = new Set();
            rootNamesByPreference[enharmonicPreference].forEach(r => { ["major", "minor"].forEach(t => { const tr = allTriads.find(x => x.root === r && x.type === t); if(tr && !added.has(tr.name)){ const o = document.createElement("option"); o.value = tr.name; o.textContent = tr.name; sel.appendChild(o); added.add(tr.name); } }) });
            if(currentTriad) sel.value = getPreferredSpelling(currentTriad).name;
        }

        // --- KEYBOARD VISUALIZATION ---
        function renderKeyboard() {
            const container = getElement("pianoContainer"); if(!container) return;
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("width", "100%"); svg.setAttribute("height", "100%"); svg.setAttribute("viewBox", "0 0 350 80");
            
            const whiteKeyWidth = 16, blackKeyWidth = 10, blackKeyHeight = 50, whiteKeyHeight = 80;
            const startMidi = 48; // C3
            let x = 0;
            const whiteKeys = [], blackKeys = [];
            
            for(let m = startMidi; m <= 84; m++) { // Up to C6
                const pc = m % 12;
                const isBlack = [1,3,6,8,10].includes(pc);
                if(!isBlack) {
                    const r = document.createElementNS(svgNS, "rect");
                    r.setAttribute("x", x); r.setAttribute("y", 0); r.setAttribute("width", whiteKeyWidth); r.setAttribute("height", whiteKeyHeight);
                    r.setAttribute("class", "piano-key white"); r.dataset.midi = m;
                    whiteKeys.push(r);
                    x += whiteKeyWidth;
                } else {
                    const r = document.createElementNS(svgNS, "rect");
                    r.setAttribute("x", x - (blackKeyWidth/2)); r.setAttribute("y", 0); r.setAttribute("width", blackKeyWidth); r.setAttribute("height", blackKeyHeight);
                    r.setAttribute("class", "piano-key black"); r.dataset.midi = m;
                    blackKeys.push(r);
                }
            }
            whiteKeys.forEach(k => svg.appendChild(k));
            blackKeys.forEach(k => svg.appendChild(k)); // Append black last to layer on top
            container.innerHTML = ""; container.appendChild(svg);
        }

        function highlightKeys(midiNotes) {
            document.querySelectorAll(".piano-key").forEach(k => k.classList.remove("active"));
            midiNotes.forEach(m => {
                const k = document.querySelector(`.piano-key[data-midi="${m}"]`);
                if(k) k.classList.add("active");
            });
        }

        // --- VISUALIZACIONES ---
        function updateCircleVisualization(act, prev) {
            const svg = document.querySelector("#hexatonicCircle svg"); if(!svg) return; svg.innerHTML = "";
            const cycle = (currentVisualizationMode==='rn'?weitzmannCycles:hexatonicCycles).find(c => c.members.some(m => m.hasSamePitchClasses(act) && m.type===act.type));
            if(!cycle) return;
            const cx = 150, cy = 150, r = 120;
            cycle.members.forEach((m, i) => {
                const ang = (i * 60 - 90) * Math.PI / 180;
                const x = cx + r * Math.cos(ang), y = cy + r * Math.sin(ang);
                const isActive = (act && m.hasSamePitchClasses(act) && m.type===act.type);
                
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", x-30); rect.setAttribute("y", y-15); rect.setAttribute("width", 60); rect.setAttribute("height", 30);
                rect.setAttribute("rx", 5); rect.setAttribute("fill", isActive ? "#3b82f6" : "#f3f4f6");
                rect.setAttribute("stroke", isActive ? "#2563eb" : "#e5e7eb");
                
                const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                txt.setAttribute("x", x); txt.setAttribute("y", y+5); txt.setAttribute("text-anchor", "middle");
                txt.setAttribute("fill", isActive ? "white" : "#4b5563");
                txt.setAttribute("font-weight", isActive ? "bold" : "normal");
                txt.textContent = getPreferredSpelling(m).name.replace(" Mayor","").replace(" menor","m");
                
                svg.appendChild(rect); svg.appendChild(txt);
                
                const nextIdx = (i + 1) % 6;
                const nextAng = (nextIdx * 60 - 90) * Math.PI / 180;
                const nextX = cx + r * Math.cos(nextAng), nextY = cy + r * Math.sin(nextAng);
                const path = document.createElementNS("http://www.w3.org/2000/svg", "line");
                path.setAttribute("x1", x); path.setAttribute("y1", y); path.setAttribute("x2", nextX); path.setAttribute("y2", nextY);
                path.setAttribute("stroke", "#e5e7eb"); path.setAttribute("stroke-width", "2");
                path.setAttribute("stroke-dasharray", "4");
                svg.insertBefore(path, rect);
            });
        }

        function drawFullTonnetz() {
            const div = getElement("tonnetzVisualization"); if(!div) return; div.innerHTML = "";
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg"); svg.setAttribute("width", "100%"); svg.setAttribute("height", "100%");
            tonnetzNodesData.forEach(n => {
                tonnetzNodesData.forEach(n2 => {
                    const dx = Math.abs(n.x - n2.x), dy = Math.abs(n.y - n2.y);
                    if ((dx === 80 && dy === 0) || (dx === 40 && dy === 75)) {
                        const l = document.createElementNS(svgNS, "line");
                        l.setAttribute("x1", n.x + 40); l.setAttribute("y1", n.y + 40); l.setAttribute("x2", n2.x + 40); l.setAttribute("y2", n2.y + 40);
                        l.setAttribute("stroke", "#e5e7eb"); svg.appendChild(l);
                    }
                });
            });
            tonnetzNodesData.forEach(n => {
                const g = document.createElementNS(svgNS, "g"); g.setAttribute("transform", `translate(${n.x+40},${n.y+40})`); g.dataset.pc = n.pc; g.classList.add("tonnetz-node-group");
                const c = document.createElementNS(svgNS, "circle"); c.setAttribute("r", 15); c.classList.add("tonnetz-node-circle"); c.setAttribute("fill", "#f8fafc"); c.setAttribute("stroke", "#cbd5e1");
                const t = document.createElementNS(svgNS, "text"); t.textContent = n.note; t.setAttribute("text-anchor", "middle"); t.setAttribute("y", 5); t.classList.add("tonnetz-node-text"); t.setAttribute("fill", "#94a3b8"); t.setAttribute("font-size", "10");
                g.appendChild(c); g.appendChild(t); svg.appendChild(g);
                g.onclick = () => highlightTonnetzByNote(n.pc);
            });
            svg.setAttribute("viewBox", "0 0 450 450");
            div.appendChild(svg);
        }

        function highlightTonnetzTriad(triad, prev) {
            const groups = document.querySelectorAll(".tonnetz-node-group");
            groups.forEach(g => {
                const c = g.querySelector("circle"), t = g.querySelector("text");
                c.setAttribute("fill", "#f8fafc"); c.setAttribute("stroke", "#cbd5e1"); c.setAttribute("stroke-width", "1");
                t.setAttribute("fill", "#94a3b8"); t.style.fontWeight = "normal";
            });
            
            // Highlight previous triad (Ghost)
            if(prev) {
                prev.pitchClasses.forEach(pc => {
                    const nodes = document.querySelectorAll(`.tonnetz-node-group[data-pc="${pc}"]`);
                    nodes.forEach(g => {
                        const c = g.querySelector("circle");
                        c.setAttribute("fill", "#dbeafe"); // Lighter blue for ghost
                    });
                });
            }

            if(triad) {
                triad.pitchClasses.forEach(pc => {
                    const nodes = document.querySelectorAll(`.tonnetz-node-group[data-pc="${pc}"]`);
                    nodes.forEach(g => {
                        const c = g.querySelector("circle"), t = g.querySelector("text");
                        c.setAttribute("fill", "#3b82f6"); c.setAttribute("stroke", "#2563eb");
                        t.setAttribute("fill", "white"); t.style.fontWeight = "bold";
                    });
                });
            }
        }
        function highlightTonnetzByNote(pc) {
             const groups = document.querySelectorAll(".tonnetz-node-group");
             groups.forEach(g => {
                 const c = g.querySelector("circle"), t = g.querySelector("text");
                 if(parseInt(g.dataset.pc) === pc) {
                     c.setAttribute("fill", "#facc15"); t.setAttribute("fill", "black");
                 } else {
                     c.setAttribute("fill", "#f8fafc"); t.setAttribute("fill", "#94a3b8");
                 }
             });
        }

        // --- QUIZ LOGIC ---
        function startQuiz() {
            isQuizMode = true;
            document.getElementById("quizContainer").classList.remove("hidden");
            document.getElementById("startQuizBtn").classList.add("hidden");
            generateQuizQuestion();
        }
        function stopQuiz() {
            isQuizMode = false;
            document.getElementById("quizContainer").classList.add("hidden");
            document.getElementById("startQuizBtn").classList.remove("hidden");
        }
        
        function generateQuizQuestion() {
            // Random start chord
            const startTriad = allTriads[Math.floor(Math.random() * allTriads.length)];
            // Random operation
            const ops = ["L", "P", "R", "N", "S", "H"];
            const quizTargetOp = ops[Math.floor(Math.random() * ops.length)];
            
            // Calculate correct result
            let correctTriad;
            if(quizTargetOp==='L') correctTriad=opL(startTriad); 
            else if(quizTargetOp==='P') correctTriad=opP(startTriad); 
            else if(quizTargetOp==='R') correctTriad=opR(startTriad);
            else if(quizTargetOp==='N') correctTriad=opN(startTriad); 
            else if(quizTargetOp==='S') correctTriad=opS(startTriad); 
            else if(quizTargetOp==='H') correctTriad=opH(startTriad);
            
            quizTargetTriadName = correctTriad.name;
            
            // Generate distractors (3 unique random triads not equal to correct)
            const options = [correctTriad];
            while(options.length < 4) {
                const randomT = allTriads[Math.floor(Math.random() * allTriads.length)];
                if(!options.some(t => t.name === randomT.name)) {
                    options.push(randomT);
                }
            }
            
            // Shuffle options
            for (let i = options.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [options[i], options[j]] = [options[j], options[i]];
            }
            
            // Update UI
            document.getElementById("quizQuestion").innerHTML = `Aplique la transformaci√≥n <span class="text-blue-600 font-bold">${quizTargetOp}</span> a <span class="font-bold">${startTriad.name}</span>`;
            document.getElementById("quizFeedback").textContent = "";
            
            const optsContainer = document.getElementById("quizOptions");
            optsContainer.innerHTML = "";
            options.forEach(opt => {
                const btn = document.createElement("button");
                btn.className = "quiz-option-btn";
                btn.textContent = opt.name;
                btn.onclick = () => checkQuizAnswer(btn, opt.name);
                optsContainer.appendChild(btn);
            });
            
            // Set current triad visually for context
            setStartChord(startTriad.name, true);
        }
        
        function checkQuizAnswer(btnElement, selectedName) {
            if(selectedName === quizTargetTriadName) {
                btnElement.classList.add("correct");
                document.getElementById("quizFeedback").innerHTML = `<span class="text-green-600">¬°Correcto!</span>`;
                setTimeout(generateQuizQuestion, 1500);
            } else {
                btnElement.classList.add("wrong");
                document.getElementById("quizFeedback").innerHTML = `<span class="text-red-600">Incorrecto. Intenta de nuevo.</span>`;
            }
        }

        // --- INICIALIZACI√ìN ---
        window.onload = () => {
            window.playVoiceLeading = playVoiceLeading;
            
            generateAllTriads(); genCycles(); populateStartChordSelect();
            setStartChord("C Mayor"); 
            renderKeyboard(); // Draw keys
            
            // Event Listeners B√°sicos
            getElement("startChord").onchange = (e) => setStartChord(e.target.value);
            getElement("resetButton").onclick = () => setStartChord("C Mayor");
            getElement("enharmonicToggle").onchange = (e) => { enharmonicPreference = e.target.checked ? 'flat' : 'sharp'; generateAllTriads(); genCycles(); populateStartChordSelect(); setStartChord(currentTriad.name, true); };
            
            // Listeners para botones de operaci√≥n
            document.querySelectorAll('button[data-op]').forEach(b => b.onclick = (e) => {
                const op = e.currentTarget.dataset.op; 
                if(isQuizMode) return; // Disable main ops in quiz mode? Or maybe just let them explore
                handleOperation(op);
            });

            // Quiz Buttons
            document.getElementById("startQuizBtn").onclick = startQuiz;
            document.getElementById("stopQuizBtn").onclick = stopQuiz;

            // Funci√≥n unificada para operaciones
            function handleOperation(op) {
                if(isInAnalysisMode) return;
                let n; 
                if(op==='L') n=opL(currentTriad); else if(op==='P') n=opP(currentTriad); else if(op==='R') n=opR(currentTriad);
                else if(op==='N') n=opN(currentTriad); else if(op==='H') n=opH(currentTriad); else if(op==='S') n=opS(currentTriad);
                
                if(n) { 
                    const fM = lastPlayedVoicing.map(x=>Tone.Frequency(x).toMidi()); 
                    const tM = getSmartVoicing(fM, n); 
                    
                    // Save context
                    const p = currentTriad; 
                    currentTriad = n; 
                    addHistoryEntry(op, p, n, fM, tM); 
                    
                    updateVoicing(tM);
                    updateUI(); 
                    displayOperationExplanation(op, p, n, fM, tM); 
                    playProgression(fM, tM); // Play full link
                }
            }

            // Analysis
            getElement("analysisSelect").onchange = (e) => { if(e.target.value) startAnalysis(e.target.value); else exitAnalysis(); };
            getElement("exitAnalysisBtn").onclick = exitAnalysis;
            getElement("nextStepBtn").onclick = () => loadAnalysisStep(currentAnalysisStep+1);
            getElement("prevStepBtn").onclick = () => loadAnalysisStep(currentAnalysisStep-1);

            // Free Analysis
            getElement("freeAnalysisButton").onclick = () => {
                const txt = getElement("freeAnalysisInput").value;
                const names = txt.split(/[\s,]+/).filter(s=>s);
                if(names.length < 2) return;
                
                const t1 = getTriadByName(names[0]);
                if(!t1) { getElement("freeAnalysisError").textContent = "Acorde no reconocido."; return; }
                getElement("freeAnalysisError").textContent = "";
                
                exitAnalysis(); history=[]; currentHistoryIndex=-1; startAudioContext();
                currentTriad = t1;
                updateVoicing(t1.getNotes().map(n=>Tone.Frequency(n.replace('‚ôØ','#').replace('‚ô≠','b')+"4").toMidi()));
                updateUI();
                
                let curr = t1, cmidi = lastPlayedVoicing.map(x=>Tone.Frequency(x).toMidi());
                for(let i=1; i<names.length; i++){
                    const next = getTriadByName(names[i]);
                    if(!next) continue;
                    const op = findBestOperation(curr, next);
                    const tMidi = getSmartVoicing(cmidi, next);
                    addHistoryEntry(op, curr, next, cmidi, tMidi);
                    curr = next; cmidi = tMidi;
                }
                currentTriad = curr; updateVoicing(cmidi); updateUI();
            };

            // Audio
            getElement("playChordButton").onclick = () => playVoicing(lastPlayedVoicing.map(x=>Tone.Frequency(x).toMidi()));
            getElement("playArpeggioButton").onclick = () => playArpeggio(lastPlayedVoicing.map(x=>Tone.Frequency(x).toMidi()));
            getElement("muteButton").onclick = () => { isMuted = !isMuted; getElement("muteButton").textContent = isMuted ? "üîá" : "üîä"; };
            
            // Visual Toggle
            getElement("vizToggle").onchange = (e) => { currentVisualizationMode = e.target.checked ? 'rn' : 'lp'; updateCircleVisualization(currentTriad, previousTriad); };

            // Modals
            getElement("glossaryButton").onclick = () => getElement("glossaryModal").classList.add("show");
            getElement("closeGlossaryButton").onclick = () => getElement("glossaryModal").classList.remove("show");
            
            // Tabs in Glossary
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                    const targetId = 'tab' + e.target.getAttribute('data-tab').charAt(0).toUpperCase() + e.target.getAttribute('data-tab').slice(1);
                    document.getElementById(targetId).classList.add('active');
                });
            });

            // Welcome Modal
            const authorModal = getElement("authorModal");
            if (authorModal) {
                setTimeout(() => authorModal.classList.add("show"), 500);
                setTimeout(() => authorModal.classList.remove("show"), 3500);
            }

            // --- ATAJOS DE TECLADO (SHORTCUTS) ---
            document.addEventListener('keydown', (e) => {
                // Ignorar si el usuario est√° escribiendo en un input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

                const key = e.key.toLowerCase();

                // Operaciones
                if (['l', 'p', 'r', 'n', 's', 'h'].includes(key)) {
                    if(isQuizMode) return; // Prevent shortcuts messing with quiz flow or add logic
                    
                    // Feedback visual en el bot√≥n
                    const btn = document.querySelector(`button[data-op="${key.toUpperCase()}"]`);
                    if(btn) {
                        btn.classList.add('ring-4', 'ring-blue-300');
                        setTimeout(() => btn.classList.remove('ring-4', 'ring-blue-300'), 150);
                    }
                    handleOperation(key.toUpperCase());
                }

                // Audio
                if (key === ' ' || key === 'spacebar') { // Espacio para Acorde
                    e.preventDefault(); // Prevenir scroll
                    document.getElementById('playChordButton').click();
                }
                if (key === 'a') { // 'A' para Arpegio
                    document.getElementById('playArpeggioButton').click();
                }
                if (key === 'm') { // 'M' para Mute
                    document.getElementById('muteButton').click();
                }

                // Navegaci√≥n An√°lisis
                if (isInAnalysisMode) {
                    if (key === 'arrowright') document.getElementById('nextStepBtn').click();
                    if (key === 'arrowleft') document.getElementById('prevStepBtn').click();
                    if (key === 'escape') document.getElementById('exitAnalysisBtn').click();
                } else {
                    // Resetear app si no est√° en an√°lisis
                    if (key === 'backspace' || key === 'delete') {
                        document.getElementById('resetButton').click();
                    }
                }
            });
        };
    </script>
</body>
</html>
