<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorador Neo-Riemanniano</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bgBody: 'var(--bg-body)',
                        bgPanel: 'var(--bg-panel)',
                        bgHeader: 'var(--bg-header)',
                        textMain: 'var(--text-main)',
                        textMuted: 'var(--text-muted)',
                        borderBase: 'var(--border-base)',
                        primary: 'var(--primary)',
                        primaryText: 'var(--primary-text)',
                        accent: 'var(--accent)',
                    }
                }
            }
        }
    </script>
    <!-- Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* --- VARIABLES DE TEMA --- */
        :root {
            /* TEMA CLARO */
            --bg-body: #f3f4f6;
            --bg-panel: #ffffff;
            --bg-header: #f9fafb;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border-base: #e5e7eb;
            --primary: #3b82f6; /* Blue 500 */
            --primary-text: #ffffff;
            --accent: #2563eb;
            
            /* Visualizaci√≥n */
            --viz-stroke: #cbd5e1;
            --viz-fill: #f8fafc;
            --viz-active: #3b82f6;
            --viz-active-text: #ffffff;
            --viz-ghost: #dbeafe;
            
            /* Piano */
            --piano-white: #ffffff;
            --piano-black: #1f2937;
            --piano-active: #3b82f6;
            
            /* Voces */
            --voice-common-bg: #dcfce7;
            --voice-common-text: #15803d;
            
            /* Hover */
            --hover-bg: #eff6ff;
        }

        html.dark {
            /* TEMA OSCURO (NE√ìN) */
            --bg-body: #0f172a; /* Slate 900 */
            --bg-panel: #1e293b; /* Slate 800 */
            --bg-header: #334155; /* Slate 700 */
            --text-main: #f1f5f9; /* Slate 100 */
            --text-muted: #94a3b8; /* Slate 400 */
            --border-base: #475569; /* Slate 600 */
            --primary: #06b6d4; /* Cyan 500 */
            --primary-text: #0f172a;
            --accent: #22d3ee; /* Cyan 400 */
            
            /* Visualizaci√≥n */
            --viz-stroke: #475569;
            --viz-fill: #334155;
            --viz-active: #22d3ee;
            --viz-active-text: #0f172a;
            --viz-ghost: #1e3a8a;
            
            /* Piano */
            --piano-white: #e2e8f0;
            --piano-black: #020617;
            --piano-active: #f472b6; /* Pink Neon */
            
            /* Voces */
            --voice-common-bg: #064e3b;
            --voice-common-text: #34d399;
            
            /* Hover */
            --hover-bg: #1e3a8a;
        }

        /* Transiciones suaves */
        body, .panel, button, input, select, textarea {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* SVG Styles din√°micos */
        .node-base { fill: var(--viz-fill); stroke: var(--viz-stroke); transition: all 0.3s; cursor: pointer; }
        .node-text { fill: var(--text-muted); pointer-events: none; user-select: none; font-size: 10px; }
        .node-active { fill: var(--viz-active) !important; stroke: var(--accent) !important; }
        .node-active-text { fill: var(--viz-active-text) !important; font-weight: bold; }
        .node-ghost { fill: var(--viz-ghost) !important; opacity: 0.6; }
        .line-connection { stroke: var(--border-base); stroke-width: 1px; }
        .op-label-text { fill: var(--text-muted); font-size: 9px; font-weight: bold; text-anchor: middle; alignment-baseline: middle; }
        .op-label-bg { fill: var(--bg-panel); stroke: var(--border-base); }
        .pole-line { stroke: var(--accent); stroke-width: 1px; stroke-dasharray: 4; opacity: 0.5; }

        /* Piano */
        .piano-key { stroke: var(--text-main); stroke-width: 1px; transition: fill 0.1s; }
        .piano-key.white { fill: var(--piano-white); }
        .piano-key.black { fill: var(--piano-black); }
        .piano-key.active { fill: var(--piano-active) !important; filter: drop-shadow(0 0 5px var(--piano-active)); }

        /* Voces */
        .voice-row { cursor: pointer; transition: background 0.2s; border-bottom: 1px solid var(--border-base); }
        .voice-row:hover { background-color: var(--hover-bg); }
        .common-tone { background-color: var(--voice-common-bg); color: var(--voice-common-text); font-weight: bold; padding: 0 4px; border-radius: 4px; }

        /* Bot√≥n Quiz */
        .quiz-btn { border: 1px solid var(--border-base); background: var(--bg-panel); color: var(--text-main); }
        .quiz-btn:hover { border-color: var(--primary); }
        .quiz-btn.correct { background: var(--voice-common-bg); color: var(--voice-common-text); border-color: var(--voice-common-text); }
        .quiz-btn.wrong { background: rgba(239,68,68,0.2); color: #ef4444; border-color: #ef4444; }

        /* Toggle */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-base); transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--primary); }
        input:checked + .toggle-slider:before { transform: translateX(20px); }
        
        /* Modales */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s; backdrop-filter: blur(2px); }
        .show { opacity: 1 !important; visibility: visible !important; }
        
        /* Pesta√±as */
        .tab-btn { padding: 8px 16px; border-bottom: 2px solid transparent; font-weight: 500; color: var(--text-muted); }
        .tab-btn.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: 700; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
    </style>
</head>
<body class="bg-bgBody text-textMain min-h-screen">
    <div class="container p-4 mx-auto max-w-[96%]">
        
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h1 class="text-2xl font-bold flex items-center gap-2">
                <span class="text-3xl text-accent">‚ú¶</span> 
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-primary to-accent">
                    Explorador Neo-Riemanniano
                </span>
            </h1>
            <button id="themeToggleBtn" class="px-4 py-2 rounded-full bg-bgPanel border border-borderBase shadow-sm hover:shadow-md transition-all text-xl" title="Cambiar Tema (Tecla: D)">
                üåû
            </button>
        </header>

        <!-- BARRA DE CONTROL GLOBAL -->
        <div class="bg-bgPanel border border-borderBase rounded-xl p-4 shadow-sm mb-6 flex flex-wrap items-center gap-4">
            <!-- Acorde Inicio -->
            <div class="flex items-center gap-2 min-w-[200px] flex-1">
                <span class="text-xs font-bold uppercase text-textMuted tracking-wider">Inicio (Start):</span>
                <select id="startChord" class="w-full bg-bgBody border border-borderBase rounded px-3 py-2 text-sm focus:outline-none focus:border-primary text-textMain"></select>
            </div>

            <!-- Toggle Enharmonic -->
            <div class="flex items-center gap-2 px-4 border-l border-borderBase">
                <span class="text-xs font-bold text-textMuted">‚ôØ</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="enharmonicToggle">
                    <span class="toggle-slider"></span>
                </label>
                <span class="text-xs font-bold text-textMuted">‚ô≠</span>
            </div>

            <!-- Audio -->
            <div class="flex items-center gap-3 px-4 border-l border-borderBase">
                <div class="flex flex-col">
                    <span class="text-[10px] uppercase text-textMuted font-bold">Vol</span>
                    <input type="range" id="volumeSlider" min="-30" max="0" value="-10" class="w-24 h-1 bg-borderBase rounded-lg appearance-none cursor-pointer">
                </div>
                <button id="muteButton" class="w-8 h-8 flex items-center justify-center rounded bg-bgBody border border-borderBase hover:border-primary transition-colors text-textMain">üîä</button>
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-2 ml-auto">
                <button id="resetButton" class="px-3 py-1.5 text-sm rounded bg-bgBody border border-borderBase hover:bg-borderBase transition-colors text-textMain font-medium" title="Atajo: Backspace">‚Ü∫ Reset</button>
                <button id="glossaryButton" class="px-3 py-1.5 text-sm font-bold text-accent rounded bg-bgBody border border-accent hover:bg-accent hover:text-white transition-colors">? Ayuda / Help</button>
            </div>
        </div>

        <!-- PANEL DE AN√ÅLISIS (Oculto por defecto) -->
        <div id="analysisControls" class="hidden bg-bgPanel border-2 border-primary rounded-xl p-4 mb-6 relative">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-primary">An√°lisis Guiado: <span id="analysisTitle" class="text-textMain"></span></h3>
                <button id="exitAnalysisBtn" class="text-xs px-3 py-1 rounded border border-red-500 text-red-500 hover:bg-red-500 hover:text-white transition-colors">‚úï Salir (Esc)</button>
            </div>
            <div class="flex flex-col gap-6">
                <!-- IMAGEN GRANDE Y CLARA -->
                <div id="analysisScoreContainer" class="w-full bg-white rounded p-2 flex items-center justify-center border border-borderBase shadow-inner min-h-[250px] relative overflow-hidden">
                    <!-- Image inserted via JS -->
                </div>
                <div class="w-full flex flex-col">
                    <div id="analysisExplanation" class="flex-grow bg-bgBody p-4 rounded border border-borderBase mb-2 text-sm overflow-y-auto text-textMain max-h-[150px]"></div>
                    <div id="analysisCitation" class="text-xs text-textMuted italic mb-4 text-center"></div>
                    <div class="flex gap-2 mt-auto">
                        <button id="prevStepBtn" class="flex-1 py-2 rounded bg-bgBody border border-borderBase hover:border-primary text-textMain">‚Üê Anterior (Prev)</button>
                        <button id="nextStepBtn" class="flex-1 py-2 rounded bg-primary text-primaryText font-bold shadow-lg hover:brightness-110">Siguiente (Next) ‚Üí</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- GRID PRINCIPAL (Fila Superior - Altura aumentada a 720px) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-32">
            
            <!-- C√≠rculo Hexat√≥nico -->
            <div class="bg-bgPanel border border-borderBase rounded-xl shadow-sm flex flex-col h-[720px]">
                <div class="p-3 border-b border-borderBase bg-bgHeader rounded-t-xl flex justify-between items-center">
                    <span class="font-bold text-sm text-textMain" id="circleTitle">C√≠rculo Hexat√≥nico</span>
                    <div class="flex items-center gap-2 text-xs text-textMuted">
                        <span>L/P</span>
                        <label class="toggle-switch scale-75" title="Atajo: V">
                            <input type="checkbox" id="vizToggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <span>R/N</span>
                    </div>
                </div>
                <div class="flex-grow relative flex flex-col items-center justify-center p-2 overflow-hidden">
                    <div id="hexatonicCircle" class="w-full h-full flex items-center justify-center">
                        <svg width="100%" height="100%" viewBox="-50 -50 400 400" preserveAspectRatio="xMidYMid meet"></svg>
                    </div>
                    <div class="absolute bottom-2 left-2 right-2 bg-bgBody/80 backdrop-blur-sm p-2 rounded text-center text-xs border border-borderBase text-textMain">
                        Ciclo: <span id="currentHexatonicCycle" class="font-bold text-accent">-</span> | Regi√≥n: <span id="currentWeitzmannRegion" class="font-bold text-accent">-</span>
                    </div>
                </div>
            </div>

            <!-- Tonnetz -->
            <div class="bg-bgPanel border border-borderBase rounded-xl shadow-sm flex flex-col h-[720px]">
                <div class="p-3 border-b border-borderBase bg-bgHeader rounded-t-xl">
                    <span class="font-bold text-sm text-textMain">Tonnetz</span>
                </div>
                <div id="vizPaneTonnetz" class="flex-grow w-full h-full overflow-hidden">
                    <div id="tonnetzVisualization" class="w-full h-full flex items-center justify-center"></div>
                </div>
            </div>

             <!-- Display Acorde & Operaciones (Altura aumentada para ver tabla completa) -->
             <div class="bg-bgPanel border border-borderBase rounded-xl p-4 shadow-sm flex flex-col h-[720px]">
                
                <!-- Secci√≥n superior: Acorde y Piano -->
                <div class="text-center mb-4 p-4 rounded-lg bg-gradient-to-br from-bgBody to-bgHeader border border-borderBase flex-shrink-0 mt-2">
                    <h2 class="text-3xl font-bold text-accent mb-1"><span id="currentChordName">C Mayor</span></h2>
                    <p class="text-sm text-textMuted tracking-[0.2em] font-mono mb-4"><span id="currentChordNotes">C E G</span></p>
                    
                    <div class="flex justify-center gap-2 mb-4">
                        <button id="playChordButton" class="px-4 py-1.5 rounded-full bg-primary text-primaryText text-xs font-bold shadow transition-transform hover:scale-105" title="Espacio">‚ñ∂ Acorde</button>
                        <button id="playArpeggioButton" class="px-4 py-1.5 rounded-full bg-bgBody border border-borderBase text-textMain text-xs font-bold hover:border-primary transition-colors" title="Tecla: A">üéπ Arpegio</button>
                    </div>

                    <!-- Piano SVG Container -->
                    <div id="pianoContainer" class="h-20 w-full rounded overflow-hidden border border-borderBase bg-white/50"></div>
                </div>

                <!-- Operaciones Grid (Ahora tiene mucho m√°s espacio abajo) -->
                <div id="operationsBox" class="flex-grow flex flex-col justify-center">
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <button class="op-btn py-3 rounded-lg bg-bgBody border border-borderBase text-textMain hover:border-primary hover:text-primary transition-all flex flex-col items-center justify-center relative group" data-op="L">
                            <strong class="text-lg">L</strong><span class="text-[9px] text-textMuted uppercase text-center leading-tight">Leading<br>Sensible</span>
                        </button>
                        <button class="op-btn py-3 rounded-lg bg-bgBody border border-borderBase text-textMain hover:border-primary hover:text-primary transition-all flex flex-col items-center justify-center relative group" data-op="P">
                            <strong class="text-lg">P</strong><span class="text-[9px] text-textMuted uppercase text-center leading-tight">Parallel<br>Paralela</span>
                        </button>
                        <button class="op-btn py-3 rounded-lg bg-bgBody border border-borderBase text-textMain hover:border-primary hover:text-primary transition-all flex flex-col items-center justify-center relative group" data-op="R">
                            <strong class="text-lg">R</strong><span class="text-[9px] text-textMuted uppercase text-center leading-tight">Relative<br>Relativa</span>
                        </button>
                        <button class="op-btn py-3 rounded-lg bg-bgBody border border-borderBase text-textMain hover:border-primary hover:text-primary transition-all flex flex-col items-center justify-center relative group" data-op="N">
                            <strong class="text-lg">N</strong><span class="text-[9px] text-textMuted uppercase text-center leading-tight">Neighbor<br>Vecina</span>
                        </button>
                        <button class="op-btn py-3 rounded-lg bg-bgBody border border-borderBase text-textMain hover:border-primary hover:text-primary transition-all flex flex-col items-center justify-center relative group" data-op="S">
                            <strong class="text-lg">S</strong><span class="text-[9px] text-textMuted uppercase text-center leading-tight">Slide<br>Deslizar</span>
                        </button>
                        <button class="op-btn py-3 rounded-lg bg-bgBody border border-borderBase text-textMain hover:border-primary hover:text-primary transition-all flex flex-col items-center justify-center relative group" data-op="H">
                            <strong class="text-lg">H</strong><span class="text-[9px] text-textMuted uppercase text-center leading-tight">Hex Pole<br>Polo</span>
                        </button>
                    </div>
                    
                    <!-- Explicaci√≥n (Conducci√≥n de voces aparecer√° aqu√≠) -->
                    <div class="bg-bgBody border border-borderBase rounded-lg p-3 min-h-[60px] flex items-center justify-center flex-col">
                        <div id="explanationTitleContainer"></div>
                        <div id="operationExplanation" class="text-xs text-center text-textMuted italic w-full">Selecciona una transformaci√≥n para ver detalles.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GRID INFERIOR (Empujada hacia abajo y con altura aumentada) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
            
            <!-- Herramientas & Quiz -->
            <div class="bg-bgPanel border border-borderBase rounded-xl overflow-hidden shadow-sm h-[500px] flex flex-col">
                <div class="bg-bgHeader p-3 border-b border-borderBase font-bold text-sm text-textMain flex justify-between items-center">
                    <span>Herramientas de An√°lisis</span>
                    <span class="text-xs text-accent">Quiz & An√°lisis Libre</span>
                </div>
                <div class="p-4 flex-grow flex flex-col gap-4 overflow-y-auto">
                    <div>
                         <label class="text-xs font-bold text-textMuted uppercase mb-1 block">An√°lisis Guiado</label>
                        <select id="analysisSelect" class="w-full p-2 text-sm bg-bgBody border border-borderBase rounded text-textMain focus:border-primary outline-none">
                            <option value="">üìÇ Seleccionar Obra...</option>
                            <option value="liszt">Liszt - Consolaci√≥n IV</option>
                            <option value="schubert">Schubert - D.946 N¬∫2</option>
                        </select>
                    </div>

                    <!-- Quiz Section -->
                    <div id="quizContainer" class="hidden bg-bgBody border border-accent/30 p-3 rounded flex-grow flex flex-col justify-center">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-accent">MODO QUIZ</span>
                            <button id="stopQuizBtn" class="text-xs underline text-textMuted hover:text-red-500">Salir</button>
                        </div>
                        <p id="quizQuestion" class="text-sm font-bold mb-3 text-center text-textMain">Pregunta...</p>
                        <div id="quizOptions" class="grid grid-cols-2 gap-2 mb-2"></div>
                        <div id="quizFeedback" class="h-6 text-center text-xs font-bold text-textMain"></div>
                    </div>
                    
                    <button id="startQuizBtn" class="w-full py-3 text-sm font-bold border border-borderBase rounded hover:bg-bgBody text-textMain transition-colors flex items-center justify-center gap-2">
                        <span>üéì</span> Iniciar Entrenamiento Auditivo (Quiz)
                    </button>

                    <div id="freeAnalysisContainer" class="mt-auto">
                         <label class="text-xs font-bold text-textMuted uppercase mb-1 block">An√°lisis Libre</label>
                        <div class="flex gap-2">
                            <textarea id="freeAnalysisInput" rows="1" class="flex-grow p-2 text-sm bg-bgBody border border-borderBase rounded resize-none text-textMain focus:border-primary outline-none" placeholder="Ej: C Am F Fm C..."></textarea>
                            <button id="freeAnalysisButton" class="px-4 py-1 bg-primary text-primaryText text-xs rounded font-bold transition-colors hover:brightness-110">Analizar</button>
                        </div>
                        <p id="freeAnalysisError" class="text-xs text-red-500 mt-1 h-4"></p>
                    </div>
                </div>
            </div>

            <!-- Historial -->
            <div class="bg-bgPanel border border-borderBase rounded-xl overflow-hidden shadow-sm h-[500px] flex flex-col">
                <div class="bg-bgHeader p-3 border-b border-borderBase font-bold text-sm text-textMain flex justify-between items-center">
                    <span>Historial de Transformaciones</span>
                    <button onclick="document.getElementById('resetButton').click()" class="text-xs text-textMuted hover:text-red-500 transition-colors">Borrar Todo</button>
                </div>
                <div id="historyLog" class="history-container overflow-y-auto flex-grow bg-bgPanel custom-scrollbar">
                    <div class="h-full flex flex-col items-center justify-center text-textMuted opacity-50">
                        <span class="text-2xl mb-2">üìú</span>
                        <p class="text-xs italic">El historial aparecer√° aqu√≠</p>
                    </div>
                </div>
            </div>

        </div>
        
        <div class="mt-8 text-center text-xs text-textMuted pb-4">
            Realizado por: <strong>Juan Miguel R√≠os Redondo</strong>
        </div>
    </div>

    <!-- MODAL AYUDA (Contenido Acad√©mico y Biling√ºe) -->
    <div id="glossaryModal" class="modal-overlay">
        <div class="modal-content bg-bgPanel rounded-xl shadow-2xl w-[90%] max-w-2xl p-6 text-textMain border border-borderBase">
            <h2 class="text-2xl font-bold text-accent mb-4 text-center">Conceptos y Operaciones (Concepts & Operations)</h2>
            <div class="flex border-b border-borderBase mb-4">
                <button class="tab-btn w-1/3 py-2 text-textMuted hover:text-textMain active border-b-2 border-primary font-bold" data-tab="operaciones">Operaciones</button>
                <button class="tab-btn w-1/3 py-2 text-textMuted hover:text-textMain" data-tab="conceptos">Teor√≠a</button>
                <button class="tab-btn w-1/3 py-2 text-textMuted hover:text-textMain" data-tab="atajos">Atajos</button>
            </div>
            
            <div id="tabOperaciones" class="tab-pane active h-[400px] overflow-y-auto text-sm space-y-6 pr-2">
                <!-- P -->
                <div class="pb-3 border-b border-borderBase">
                    <div class="flex items-center gap-2 mb-1">
                        <strong class="text-lg text-primary">P</strong> 
                        <span class="font-bold text-textMain">Parallel / Paralela</span>
                    </div>
                    <p class="text-textMuted mb-1">
                        Relaciona una tr√≠ada mayor con su menor paralela (y viceversa). Ambas comparten la <strong>fundamental</strong> y la <strong>quinta</strong>. La tercera se mueve un semitono.
                    </p>
                    <p class="text-xs italic bg-bgBody p-1 rounded inline-block border border-borderBase">
                        <em>Ejemplo: C Major (C-E-G) ‚Üî C Minor (C-Eb-G).</em>
                    </p>
                </div>
                <!-- L -->
                <div class="pb-3 border-b border-borderBase">
                    <div class="flex items-center gap-2 mb-1">
                        <strong class="text-lg text-primary">L</strong> 
                        <span class="font-bold text-textMain">Leading-Tone Exchange / Intercambio de Sensible</span>
                    </div>
                    <p class="text-textMuted mb-1">
                        Transforma una tr√≠ada mayor moviendo su fundamental un semitono hacia abajo (convirti√©ndose en la sensible de la relativa menor). Se conservan la <strong>tercera menor</strong> y la <strong>quinta</strong>.
                    </p>
                    <p class="text-xs italic bg-bgBody p-1 rounded inline-block border border-borderBase">
                        <em>Ejemplo: C Major (C-E-G) ‚Üî E Minor (B-E-G). Note C ‚Üí B.</em>
                    </p>
                </div>
                <!-- R -->
                <div class="pb-3 border-b border-borderBase">
                    <div class="flex items-center gap-2 mb-1">
                        <strong class="text-lg text-primary">R</strong> 
                        <span class="font-bold text-textMain">Relative / Relativa</span>
                    </div>
                    <p class="text-textMuted mb-1">
                        Relaciona una tr√≠ada mayor con su relativa menor cl√°sica. Se conserva la <strong>tercera mayor</strong> com√∫n.
                    </p>
                    <p class="text-xs italic bg-bgBody p-1 rounded inline-block border border-borderBase">
                        <em>Ejemplo: C Major (C-E-G) ‚Üî A Minor (C-E-A). Note G ‚Üí A.</em>
                    </p>
                </div>
                <!-- N -->
                <div class="pb-3 border-b border-borderBase">
                    <div class="flex items-center gap-2 mb-1">
                        <strong class="text-lg text-primary">N</strong> 
                        <span class="font-bold text-textMain">Neighbor / Vecina</span>
                    </div>
                    <p class="text-textMuted mb-1">
                        Relaciona una tr√≠ada con su "vecina" en el Tonnetz. Desde una tr√≠ada mayor, conduce a su subdominante menor. Es una operaci√≥n compuesta equivalente a aplicar <strong>R</strong>, luego <strong>L</strong>, luego <strong>P</strong>.
                    </p>
                </div>
                <!-- S -->
                <div class="pb-3 border-b border-borderBase">
                    <div class="flex items-center gap-2 mb-1">
                        <strong class="text-lg text-primary">S</strong> 
                        <span class="font-bold text-textMain">Slide / Deslizamiento</span>
                    </div>
                    <p class="text-textMuted mb-1">
                        Dos tr√≠adas que comparten la <strong>tercera</strong>, pero invierten su funci√≥n (de tercera mayor a menor). Implica un movimiento crom√°tico paralelo de la fundamental y la quinta. Equivale a la secuencia de operaciones <strong>L-P-R</strong> o, alternativamente, <strong>R-N-R</strong>.
                    </p>
                    <p class="text-xs italic bg-bgBody p-1 rounded inline-block border border-borderBase">
                        <em>Ejemplo: C Major (C-E-G) ‚Üî C# Minor (C#-E-G#).</em>
                    </p>
                </div>
                <!-- H -->
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <strong class="text-lg text-primary">H</strong> 
                        <span class="font-bold text-textMain">Hexatonic Pole / Polo Hexat√≥nico</span>
                    </div>
                    <p class="text-textMuted mb-1">
                        Conecta una tr√≠ada con su complemento hexat√≥nico opuesto. No comparten ninguna nota. Es la suma de <strong>L-P-L</strong> o <strong>P-L-P</strong>.
                    </p>
                    <p class="text-xs italic bg-bgBody p-1 rounded inline-block border border-borderBase">
                        <em>Ejemplo: C Major (C-E-G) ‚Üî Ab Minor (Cb-Eb-Ab).</em>
                    </p>
                </div>
            </div>
            
            <!-- Pesta√±a Teor√≠a -->
            <div id="tabConceptos" class="tab-pane hidden h-[400px] overflow-y-auto text-sm space-y-6 pr-2">
                <div class="pb-4 border-b border-borderBase">
                    <strong class="text-accent text-lg block mb-2">Ciclos L/P (Hexatonic Cycles)</strong>
                    <p class="text-textMuted leading-relaxed">
                        Son cadenas cerradas de 6 acordes generadas alternando las operaciones <strong>Leittonwechsel (L)</strong> y <strong>Parallel (P)</strong>. Estos ciclos recorren un conjunto de 6 clases de alturas que forman la escala hexat√≥nica (set-class 6-20), caracterizada por la alternancia de semitonos y terceras menores (1, 3, 1, 3...).
                    </p>
                    <p class="text-xs italic bg-bgBody p-2 mt-2 rounded border border-borderBase block">
                        <em>Ejemplo: C Major ‚Üí E Minor ‚Üí E Major ‚Üí C# Minor ‚Üí Ab Major ‚Üí Ab Minor ‚Üí C Major.</em>
                    </p>
                    <p class="text-textMuted mt-2 leading-relaxed">
                        Musicalmente, estos ciclos carecen de un centro tonal estable, creando una sensaci√≥n de "flotaci√≥n" arm√≥nica muy utilizada por compositores como Wagner, Liszt y Rimsky-Korsakov para suspender la tonalidad funcional.
                    </p>
                </div>

                <div class="pb-4 border-b border-borderBase">
                    <strong class="text-accent text-lg block mb-2">Ciclos R/N (Weitzmann Regions)</strong>
                    <p class="text-textMuted leading-relaxed">
                        Estas regiones se generan alternando las operaciones <strong>Relative (R)</strong> y <strong>Neighbor (N)</strong>. A diferencia de los ciclos hexat√≥nicos, estos ciclos exploran relaciones de tercera menor y vecindad crom√°tica alrededor de un eje t√≥nico-dominante impl√≠cito extendido.
                    </p>
                    <p class="text-xs italic bg-bgBody p-2 mt-2 rounded border border-borderBase block">
                        <em>Ejemplo: C Major ‚Üí A Minor ‚Üí F Major ‚Üí D Minor...</em>
                    </p>
                </div>

                <div class="pb-4 border-b border-borderBase">
                    <strong class="text-accent text-lg block mb-2">Tonnetz (Tone Network)</strong>
                    <p class="text-textMuted leading-relaxed">
                        El Tonnetz es una representaci√≥n geom√©trica del espacio arm√≥nico, originada por Euler y desarrollada por Riemann. A diferencia del c√≠rculo de quintas (que solo muestra cercan√≠a por quintas), el Tonnetz mapea las relaciones de:
                    </p>
                    <ul class="list-disc list-inside mt-2 text-textMuted pl-2">
                        <li><strong>Eje Horizontal:</strong> Quintas Justas (Perfect 5ths).</li>
                        <li><strong>Diagonal (/):</strong> Terceras Mayores (Major 3rds).</li>
                        <li><strong>Diagonal (\):</strong> Terceras Menores (Minor 3rds).</li>
                    </ul>
                </div>
            </div>
            
            <!-- Nueva Pesta√±a Atajos -->
            <div id="tabAtajos" class="tab-pane hidden h-[400px] overflow-y-auto text-sm space-y-4 pr-2">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-bgBody p-3 rounded border border-borderBase">
                        <strong class="block text-accent mb-2">Operaciones</strong>
                        <ul class="space-y-1 text-textMuted">
                            <li><kbd class="bg-white dark:bg-slate-700 px-1 rounded border">L</kbd> : Leittonwechsel</li>
                            <li><kbd class="bg-white dark:bg-slate-700 px-1 rounded border">P</kbd> : Parallel</li>
                            <li><kbd class="bg-white dark:bg-slate-700 px-1 rounded border">R</kbd> : Relative</li>
                            <li><kbd class="bg-white dark:bg-slate-700 px-1 rounded border">N</kbd> : Neighbor</li>
                            <li><kbd class="bg-white dark:bg-slate-700 px-1 rounded border">S</kbd> : Slide</li>
                            <li><kbd class="bg-white dark:bg-slate-700 px-1 rounded border">H</kbd> : Hexatonic Pole</li>
                            <li><kbd class="bg-white dark:bg-slate-700 px-1 rounded border">E</kbd> : Toggle ‚ôØ/‚ô≠</li>
                        </ul>
                    </div>
                    <div class="bg-bgBody p-3 rounded border border-borderBase">
                        <strong class="block text-accent mb-2">Navegaci√≥n y Audio</strong>
                        <ul class="space-y-1 text-textMuted">
                            <li><kbd class="bg-white dark:bg-slate-700 px-1 rounded border">V</kbd> : Cambiar Vista L/P - R/N</li>
                            <li><kbd class="bg-white dark:bg-slate-700 px-1 rounded border">D</kbd> : Tema Oscuro/Claro</li>
                            <li><kbd class="bg-white dark:bg-slate-700 px-1 rounded border">Espacio</kbd> : Reproducir Acorde</li>
                            <li><kbd class="bg-white dark:bg-slate-700 px-1 rounded border">A</kbd> : Arpegio</li>
                            <li><kbd class="bg-white dark:bg-slate-700 px-1 rounded border">M</kbd> : Silenciar/Mute</li>
                            <li><kbd class="bg-white dark:bg-slate-700 px-1 rounded border">‚Üê</kbd> / <kbd class="bg-white dark:bg-slate-700 px-1 rounded border">‚Üí</kbd> : Pasos de An√°lisis</li>
                            <li><kbd class="bg-white dark:bg-slate-700 px-1 rounded border">Esc</kbd> : Salir de An√°lisis</li>
                            <li><kbd class="bg-white dark:bg-slate-700 px-1 rounded border">Backspace</kbd> : Resetear App</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <button id="closeGlossaryButton" class="w-full mt-4 py-2 bg-primary text-primaryText rounded font-bold transition-colors hover:brightness-110">Cerrar (Close)</button>
        </div>
    </div>

    <!-- MODAL BIENVENIDA -->
    <div id="authorModal" class="modal-overlay">
         <div class="modal-content bg-bgPanel p-6 rounded-xl shadow-2xl text-center max-w-sm border border-borderBase">
            <h2 class="text-xl font-bold text-accent mb-2">¬°Bienvenido!</h2>
            <p class="text-textMuted">Explorador de Teor√≠a Neo-Riemanniana</p>
        </div>
    </div>

    <script>
        // --- MOTOR DE L√ìGICA ---
        
        let currentTriad, previousTriad = null, history = [], currentHistoryIndex = -1;
        let hexatonicCycles = [], weitzmannCycles = [];
        let currentVisualizationMode = 'lp', isInAnalysisMode = false, currentAnalysis = null, currentAnalysisStep = 0;
        let enharmonicPreference = 'sharp';
        let isToneStarted = false, isMuted = false, lastPlayedVoicing = [];
        let isQuizMode = false, quizTargetTriadName = null;
        let visualRotationRoot = null; // New state for rotation anchor

        const voiceColors = ['#ef4444', '#22c55e', '#3b82f6']; 

        const synth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" }, envelope: { attack: 0.05, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
        const arpeggioSynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.05, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();

        const noteToPitchClass = { "C":0, "C‚ôØ":1, "D‚ô≠":1, "D":2, "D‚ôØ":3, "E‚ô≠":3, "E":4, "F":5, "F‚ôØ":6, "G‚ô≠":6, "G":7, "G‚ôØ":8, "A‚ô≠":8, "A":9, "A‚ôØ":10, "B‚ô≠":10, "B":11, "E‚ôØ":5, "B‚ôØ":0, "C‚ô≠":11, "F‚ô≠":4, "Gx":9, "Ax":11 };
        const canonicalSpelling = {
            sharp: { 0:"C", 1:"C‚ôØ", 2:"D", 3:"D‚ôØ", 4:"E", 5:"F", 6:"F‚ôØ", 7:"G", 8:"G‚ôØ", 9:"A", 10:"A‚ôØ", 11:"B" },
            flat:  { 0:"C", 1:"D‚ô≠", 2:"D", 3:"E‚ô≠", 4:"E", 5:"F", 6:"G‚ô≠", 7:"G", 8:"A‚ô≠", 9:"A", 10:"B‚ô≠", 11:"B" }
        };
        const allPossibleRootNames = ["C", "C‚ôØ", "D‚ô≠", "D", "D‚ôØ", "E‚ô≠", "E", "F", "F‚ôØ", "G‚ô≠", "G", "G‚ôØ", "A‚ô≠", "A", "A‚ôØ", "B‚ô≠", "B"];
        const rootNamesByPreference = {
            sharp: ["C", "C‚ôØ", "D", "D‚ôØ", "E", "F", "F‚ôØ", "G", "G‚ôØ", "A", "A‚ôØ", "B"],
            flat:  ["C", "D‚ô≠", "D", "E‚ô≠", "E", "F", "G‚ô≠", "G", "A‚ô≠", "A", "B‚ô≠", "B"]
        };

        // TONNETZ EXTENDIDO
        const tonnetzNodesData = [
            { note: "D‚ôØ", pc: 3, x: -150, y: 0 }, { note: "A‚ôØ", pc: 10, x: -70, y: 0 }, { note: "E‚ôØ", pc: 5, x: 10, y: 0 }, { note: "B‚ôØ", pc: 0, x: 90, y: 0 }, { note: "Gx", pc: 9, x: 170, y: 0 }, { note: "Dx", pc: 4, x: 250, y: 0 },
            { note: "G‚ôØ", pc: 8, x: -110, y: 75 }, { note: "D‚ôØ", pc: 3, x: -30, y: 75 }, { note: "A‚ôØ", pc: 10, x: 50, y: 75 }, { note: "F", pc: 5, x: 130, y: 75 }, { note: "C", pc: 0, x: 210, y: 75 }, { note: "G", pc: 7, x: 290, y: 75 },
            { note: "C‚ôØ", pc: 1, x: -150, y: 150 }, { note: "G‚ôØ", pc: 8, x: -70, y: 150 }, { note: "D‚ôØ", pc: 3, x: 10, y: 150 }, { note: "A‚ôØ", pc: 10, x: 90, y: 150 }, { note: "F", pc: 5, x: 170, y: 150 }, { note: "C", pc: 0, x: 250, y: 150 }, { note: "G", pc: 7, x: 330, y: 150 },
            { note: "F‚ôØ", pc: 6, x: -110, y: 225 }, { note: "C‚ôØ", pc: 1, x: -30, y: 225 }, { note: "G‚ôØ", pc: 8, x: 50, y: 225 }, { note: "D‚ôØ", pc: 3, x: 130, y: 225 }, { note: "A‚ôØ", pc: 10, x: 210, y: 225 }, { note: "F", pc: 5, x: 290, y: 225 },
            { note: "B", pc: 11, x: -150, y: 300 }, { note: "F‚ôØ", pc: 6, x: -70, y: 300 }, { note: "C‚ôØ", pc: 1, x: 10, y: 300 }, { note: "G‚ôØ", pc: 8, x: 90, y: 300 }, { note: "D‚ôØ", pc: 3, x: 170, y: 300 }, { note: "A‚ôØ", pc: 10, x: 250, y: 300 }, { note: "F", pc: 5, x: 330, y: 300 },
            { note: "E", pc: 4, x: -110, y: 375 }, { note: "B", pc: 11, x: -30, y: 375 }, { note: "F‚ôØ", pc: 6, x: 50, y: 375 }, { note: "C‚ôØ", pc: 1, x: 130, y: 375 }, { note: "G‚ôØ", pc: 8, x: 210, y: 375 }, { note: "D‚ôØ", pc: 3, x: 290, y: 375 },
            { note: "A", pc: 9, x: -70, y: 450 }, { note: "E", pc: 4, x: 10, y: 450 }, { note: "B", pc: 11, x: 90, y: 450 }, { note: "F‚ôØ", pc: 6, x: 170, y: 450 }, { note: "C‚ôØ", pc: 1, x: 250, y: 450 }
        ];

        // DATOS ANALISIS
        const analysisData = {
            'liszt': { 
                name: "Liszt - Consolaci√≥n IV", 
                imageUrl: "https://raw.githubusercontent.com/juanmiguel0927/TeoriaNeo-Riemanniana/f5b5e3be5b7127f25004f8fa6f6a8086515f617a/Liszt.png", 
                citation: "Calabrese, A. (2025). <em>Armon√≠a de los Siglos XIX al XXI: Claves para navegar el espacio crom√°tico</em>. Omb√∫ Ediciones Musicales.",
                steps: [ { chord: 'B‚ô≠ menor', op: null, text: "Inicio en Si‚ô≠m." }, { chord: 'D‚ô≠ Mayor', op: 'R', text: "Relativa Mayor." }, { chord: 'D‚ô≠ menor', op: 'P', text: "Paralela Menor." }, { chord: 'E Mayor', op: 'R', text: "Relativa (Fb)." }, { chord: 'E menor', op: 'P', text: "Paralela Menor." }, { chord: 'G menor', op: null, text: "Salto crom√°tico." } ] 
            },
            'schubert': { 
                name: "Schubert - D.946 N¬∫2", 
                imageUrl: "https://raw.githubusercontent.com/juanmiguel0927/TeoriaNeo-Riemanniana/f5b5e3be5b7127f25004f8fa6f6a8086515f617a/Schubert.png", 
                citation: "Calabrese, A. (2025). <em>Armon√≠a de los Siglos XIX al XXI: Claves para navegar el espacio crom√°tico</em>. Omb√∫ Ediciones Musicales.",
                steps: [ { chord: 'D menor', op: null, text: "Inicio Dm." }, { chord: 'A Mayor', op: 'N', text: "Vecina (Dominante)." }, { chord: 'F menor', op: 'H', text: "Polo Hexat√≥nico." }, { chord: 'C Mayor', op: 'N', text: "Vecina." }, { chord: 'A‚ô≠ menor', op: 'H', text: "Polo Hexat√≥nico." } ] 
            }
        };

        function normalizePitch(pc) { return (pc % 12 + 12) % 12; }
        function getNoteNameFromMidi(midi, pref = enharmonicPreference) { return canonicalSpelling[pref][normalizePitch(midi)] + (Math.floor(midi/12)-1); }
        function getElement(id) { return document.getElementById(id); }
        function safeClassListRemove(id, cls) { const el = getElement(id); if(el) el.classList.remove(cls); }
        function safeClassListAdd(id, cls) { const el = getElement(id); if(el) el.classList.add(cls); }

        class Triad {
            constructor(root, type) { this.root = root; this.type = type; this.pitchClasses = this.calcPC(); this.name = `${root} ${type === 'major' ? 'Mayor' : 'menor'}`; }
            calcPC() { const r = noteToPitchClass[this.root]; return (this.type==='major'?[r, normalizePitch(r+4), normalizePitch(r+7)]:[r, normalizePitch(r+3), normalizePitch(r+7)]).sort((a,b)=>a-b); }
            getNotes() { const r=noteToPitchClass[this.root]; const t=(this.type==='major')?normalizePitch(r+4):normalizePitch(r+3); const f=normalizePitch(r+7); const s=(pc)=>canonicalSpelling[enharmonicPreference][pc]; return [this.root, s(t), s(f)]; }
            hasSamePitchClasses(o) { return this.pitchClasses.every((p,i)=>p===o.pitchClasses[i]); }
        }

        let allTriads = [];
        function generateAllTriads() { allTriads = []; const added = new Set(); allPossibleRootNames.forEach(r => { ["major", "minor"].forEach(t => { const tr = new Triad(r, t); if(!added.has(tr.name)){ allTriads.push(tr); added.add(tr.name); } }) }); }
        function getTriadByName(n) { if(!n)return null; let nm = n.trim().replace(/b/g,'‚ô≠').replace(/#/g,'‚ôØ'); let type = (nm.toLowerCase().includes("m") && !nm.includes("Mayor")) ? "minor" : "major"; nm = nm.replace(/menor|major|mayor|m/gi, '').trim(); let r = nm.charAt(0).toUpperCase() + nm.slice(1); return allTriads.find(t=>t.name===`${r} ${type==='major'?'Mayor':'menor'}`); }
        function getPreferredSpelling(t) { if(!t)return null; const r = noteToPitchClass[t.root]; const pr = canonicalSpelling[enharmonicPreference][r]; return allTriads.find(x=>x.root===pr && x.type===t.type)||t; }
        function findTriadByPitchClasses(pcs, type) { const s = [...pcs].sort((a,b)=>a-b); return allTriads.find(t=>t.type===type && t.pitchClasses.every((p,i)=>p===s[i])) || null; }

        function opL(t) { const r = noteToPitchClass[t.root]; return t.type==='major' ? findTriadByPitchClasses([normalizePitch(r+4),normalizePitch(r+7),normalizePitch(r-1)], 'minor') : findTriadByPitchClasses([normalizePitch(r+7+1),r,normalizePitch(r+3)], 'major'); }
        function opP(t) { const r = noteToPitchClass[t.root]; return t.type==='major' ? findTriadByPitchClasses([r,normalizePitch(r+3),normalizePitch(r+7)], 'minor') : findTriadByPitchClasses([r,normalizePitch(r+4),normalizePitch(r+7)], 'major'); }
        function opR(t) { const r = noteToPitchClass[t.root]; return t.type==='major' ? findTriadByPitchClasses([normalizePitch(r-3),r,normalizePitch(r+4)], 'minor') : findTriadByPitchClasses([normalizePitch(r+3),normalizePitch(r+7),normalizePitch(r+10)], 'major'); }
        function opN(t) { const r = noteToPitchClass[t.root]; return t.type==='major' ? findTriadByPitchClasses([normalizePitch(r+5),normalizePitch(r+8),r], 'minor') : findTriadByPitchClasses([normalizePitch(r+7),normalizePitch(r-1),normalizePitch(r+2)], 'major'); }
        function opH(t) { let p=opP(t); if(!p)return null; let l=opL(p); if(!l)return null; return opP(l); }
        function opS(t) { let r=opR(t); if(!r)return null; let n=opN(r); if(!n)return null; return opR(n); }
        
        function findOperationPath(startTriad, targetTriad) {
            const queue = [{triad: startTriad, path: []}]; const visited = new Set([startTriad.name]);
            while(queue.length > 0) {
                const {triad, path} = queue.shift();
                if(triad.hasSamePitchClasses(targetTriad) && triad.type === targetTriad.type) return path.join("");
                if(path.length >= 4) continue;
                const ops = [['L', opL], ['P', opP], ['R', opR]];
                for(let [name, func] of ops) {
                    const nextT = func(triad);
                    if(nextT && !visited.has(nextT.name)) { visited.add(nextT.name); queue.push({triad: nextT, path: [...path, name]}); }
                }
            }
            return null; 
        }
        function findBestOperation(a, b) { 
            if(opP(a)&&opP(a).hasSamePitchClasses(b)) return 'P'; 
            if(opL(a)&&opL(a).hasSamePitchClasses(b)) return 'L'; 
            if(opR(a)&&opR(a).hasSamePitchClasses(b)) return 'R'; 
            if(opN(a)&&opN(a).hasSamePitchClasses(b)) return 'N'; 
            if(opS(a)&&opS(a).hasSamePitchClasses(b)) return 'S'; 
            if(opH(a)&&opH(a).hasSamePitchClasses(b)) return 'H'; 
            const path = findOperationPath(a, b); return path || '??'; 
        }

        function genCycles() {
            const start = canonicalSpelling[enharmonicPreference];
            hexatonicCycles = []; weitzmannCycles = [];
            [0,1,2,3].forEach(i => {
                let c = [], curr = getTriadByName(`${start[i]} Mayor`);
                for(let k=0;k<6;k++) { if(curr) c.push(curr); curr=(k%2===0)?opL(curr):opP(curr); }
                hexatonicCycles.push({name: `Ciclo ${i+1}`, members: c.filter(Boolean)});
                c = []; curr = getTriadByName(`${start[i]} Mayor`);
                for(let k=0;k<6;k++) { if(curr) c.push(curr); curr=(k%2===0)?opR(curr):opN(curr); }
                weitzmannCycles.push({name: `Regi√≥n ${i+1}`, members: c.filter(Boolean)});
            });
        }
        function getHexatonicCycleForTriad(triad) { if (!triad) return null; return hexatonicCycles.find(cycle => cycle.members.some(member => member.hasSamePitchClasses(triad) && member.type === triad.type)); }
        function getWeitzmannRegionForTriad(triad) { if (!triad) return null; return weitzmannCycles.find(cycle => cycle.members.some(member => member.hasSamePitchClasses(triad) && member.type === triad.type)); }

        // --- GESTI√ìN DE AN√ÅLISIS ---
        function exitAnalysis() {
            isInAnalysisMode = false; currentAnalysis = null;
            const sel = getElement("analysisSelect"); if(sel) sel.value = "";
            safeClassListAdd("analysisControls", "hidden");
            safeClassListRemove("startChordContainer", "hidden");
            safeClassListRemove("operationsBox", "hidden");
            safeClassListRemove("freeAnalysisContainer", "hidden");
            history = []; currentHistoryIndex = -1; updateHistoryLog();
        }
        function startAnalysis(key) {
            isInAnalysisMode = true; currentAnalysis = analysisData[key]; currentAnalysisStep = 0;
            const t = getElement("analysisTitle"); if(t) t.textContent = currentAnalysis.name;
            const cit = getElement("analysisCitation"); if(cit) cit.innerHTML = currentAnalysis.citation || ""; 
            const cont = getElement("analysisScoreContainer");
            if(cont) { 
                if(currentAnalysis.imageUrl) {
                    cont.innerHTML = `<img id="analysisScoreImage" src="${currentAnalysis.imageUrl}" alt="Partitura" class="w-full h-auto shadow-sm" onerror="this.style.display='none'; this.parentElement.innerHTML='<p class=\\'text-gray-400 italic p-4\\'>Imagen no disponible.</p>'">`;
                    cont.classList.remove('hidden'); 
                } 
                else { cont.classList.add('hidden'); } 
            }
            safeClassListRemove("analysisControls", "hidden");
            safeClassListAdd("startChordContainer", "hidden");
            safeClassListAdd("operationsBox", "hidden");
            safeClassListAdd("freeAnalysisContainer", "hidden");
            loadAnalysisStep(0);
        }
        function loadAnalysisStep(idx) {
            if (!currentAnalysis || idx < 0 || idx >= currentAnalysis.steps.length) return;
            currentAnalysisStep = idx;
            const step = currentAnalysis.steps[idx];
            const newTriad = getPreferredSpelling(getTriadByName(step.chord));
            const prevStep = (idx > 0) ? currentAnalysis.steps[idx - 1] : null;
            const oldTriad = prevStep ? getPreferredSpelling(getTriadByName(prevStep.chord)) : null;
            previousTriad = oldTriad; currentTriad = newTriad;
            startAudioContext();
            let fMidi, tMidi;
            if (oldTriad) {
                fMidi = lastPlayedVoicing.map(n => Tone.Frequency(n).toMidi());
                tMidi = getSmartVoicing(fMidi, newTriad);
                updateVoicing(tMidi);
            } else {
                tMidi = newTriad.getNotes().map(n => Tone.Frequency(n.replace('‚ôØ','#').replace('‚ô≠','b')+"4").toMidi());
                fMidi = tMidi; updateVoicing(tMidi);
            }
            updateUI();
            displayOperationExplanation(step.op || "Siguiente", oldTriad, newTriad, fMidi, tMidi);
            const desc = getElement("operationExplanation");
            if(desc) desc.innerHTML = `<p class="mb-2 font-bold text-accent">${step.text}</p>` + desc.innerHTML;
            if (idx > 0) addHistoryEntry(step.op || "Siguiente", oldTriad, newTriad, fMidi, tMidi); else { history=[]; currentHistoryIndex=-1; updateHistoryLog(); }
            const prevBtn = getElement("prevStepBtn"); if(prevBtn) prevBtn.disabled = (idx === 0);
            const nextBtn = getElement("nextStepBtn"); if(nextBtn) nextBtn.disabled = (idx === currentAnalysis.steps.length - 1);
        }

        // --- FUNCIONES UI PRINCIPALES ---
        function setStartChord(name, preserve) {
            if(!preserve) exitAnalysis();
            const newStart = getPreferredSpelling(getTriadByName(name) || allTriads[0]);
            visualRotationRoot = newStart; 
            currentTriad = newStart;
            
            // Sync the dropdown explicitly to match internal state
            const sel = getElement("startChord");
            if(sel && newStart) sel.value = newStart.name;

            if(!preserve) { history=[]; currentHistoryIndex=-1; previousTriad=null; updateVoicing(currentTriad.getNotes().map(n=>Tone.Frequency(n.replace('‚ôØ','#').replace('‚ô≠','b')+"4").toMidi())); }
            updateUI(); if(!preserve) displayOperationExplanation('');
        }
        async function startAudioContext() { if(!isToneStarted){ await Tone.start(); isToneStarted=true; } }
        function updateVoicing(m) { lastPlayedVoicing = m.map(x=>Tone.Frequency(x,"midi").toNote()); }
        
        function getSmartVoicing(fromMidi, toTriad) {
            const targetPcs = toTriad.pitchClasses; let newVoicing = new Array(fromMidi.length).fill(null); let availableTargetPcs = [...targetPcs];
            for(let i=0; i < fromMidi.length; i++) {
                const currentPc = fromMidi[i] % 12;
                if(availableTargetPcs.includes(currentPc)) { newVoicing[i] = fromMidi[i]; const idx = availableTargetPcs.indexOf(currentPc); if(idx > -1) availableTargetPcs.splice(idx, 1); }
            }
            for(let i=0; i < newVoicing.length; i++) {
                if(newVoicing[i] === null) {
                    const startNote = fromMidi[i]; let bestMidi = -1; let minDist = Infinity;
                    for(let j=0; j < availableTargetPcs.length; j++) {
                        const targetPc = availableTargetPcs[j]; const currentOctaveBase = Math.floor(startNote / 12) * 12;
                        const candidates = [currentOctaveBase + targetPc, currentOctaveBase + targetPc + 12, currentOctaveBase + targetPc - 12];
                        for(let cand of candidates) { const dist = Math.abs(cand - startNote); if(dist < minDist) { minDist = dist; bestMidi = cand; } }
                    }
                    newVoicing[i] = bestMidi; const usedPc = bestMidi % 12; const idx = availableTargetPcs.indexOf(usedPc); if(idx > -1) availableTargetPcs.splice(idx, 1);
                }
            }
            return newVoicing;
        }

        // --- AUDIO ---
        function playProgression(fromMidi, toMidi) {
            if(isMuted) return; startAudioContext(); const now = Tone.now();
            const notes1 = fromMidi.map(m => Tone.Frequency(m, "midi").toNote());
            highlightKeys(fromMidi); synth.triggerAttackRelease(notes1, "2n", now);
            const notes2 = toMidi.map(m => Tone.Frequency(m, "midi").toNote());
            setTimeout(() => highlightKeys(toMidi), 1000); synth.triggerAttackRelease(notes2, "1n", now + 1);
        }
        function playVoicing(m) { if(isMuted)return; startAudioContext(); updateVoicing(m); synth.triggerAttackRelease(lastPlayedVoicing, "1s"); highlightKeys(m); }
        function playArpeggio(m) { if(isMuted)return; startAudioContext(); highlightKeys(m); [...m].sort((a,b)=>a-b).map(x=>Tone.Frequency(x,"midi").toNote()).forEach((n,i)=>arpeggioSynth.triggerAttackRelease(n, "8n", Tone.now()+i*0.15)); }
        function playVoiceLeading(midiFrom, midiTo) {
             if(isMuted) return; startAudioContext();
             const n1 = Tone.Frequency(midiFrom, "midi").toNote(); const n2 = Tone.Frequency(midiTo, "midi").toNote();
             const now = Tone.now(); highlightKeys([midiFrom]); arpeggioSynth.triggerAttackRelease(n1, "8n", now);
             setTimeout(() => highlightKeys([midiTo]), 300); arpeggioSynth.triggerAttackRelease(n2, "4n", now + 0.3);
        }

        // --- UI ---
        function updateUI() {
            if(!currentTriad) return;
            currentTriad = getPreferredSpelling(currentTriad);
            const notes = currentTriad.getNotes();
            const nm = getElement("currentChordName"); if(nm) nm.textContent = currentTriad.name;
            const cn = getElement("currentChordNotes"); if(cn) cn.innerHTML = notes.join(" - ");
            updateHistoryLog(); updateSetRelationshipsDisplay(); updateCircleVisualization(currentTriad, previousTriad); drawFullTonnetz(); highlightTonnetzTriad(currentTriad, previousTriad);
            highlightKeys(lastPlayedVoicing.map(n => Tone.Frequency(n).toMidi()));
        }
        function updateHistoryLog() {
            const log = getElement("historyLog"); if(!log) return; log.innerHTML = "";
            if(history.length === 0) { log.innerHTML = '<div class="h-full flex flex-col items-center justify-center text-textMuted opacity-50"><span class="text-2xl mb-2">üìú</span><p class="text-xs italic">El historial aparecer√° aqu√≠</p></div>'; return; }
            [...history].reverse().forEach((h, i) => {
                const div = document.createElement("div");
                div.className = `history-item border-b border-borderBase p-2 flex justify-between cursor-pointer hover:bg-bgBody ${history.length-1-i===currentHistoryIndex?'bg-blue-50 border-l-4 border-l-primary':''}`;
                const fT = getPreferredSpelling(getTriadByName(h.from)); const tT = getPreferredSpelling(getTriadByName(h.to));
                div.innerHTML = `<span class="text-textMain text-sm">${fT?fT.name:h.from} <span class="text-accent font-bold">‚Üí</span> ${tT?tT.name:h.to}</span> <span class="text-xs bg-bgPanel border border-borderBase px-2 py-0.5 rounded font-bold">${h.operation}</span>`;
                div.onclick = () => { 
                    if(isInAnalysisMode) { loadAnalysisStep((history.length - 1 - i) + 1); } 
                    else { 
                        currentHistoryIndex = history.length-1-i; currentTriad = getTriadByName(h.to); 
                        const tMidi = h.toMidi; const fMidi = h.fromMidi;
                        updateVoicing(tMidi); updateUI(); 
                        displayOperationExplanation(h.operation, getTriadByName(h.from), currentTriad, fMidi, tMidi); 
                        playProgression(fMidi, tMidi); 
                    }
                };
                log.appendChild(div);
            });
        }
        function displayOperationExplanation(op, from, to, fMidi, tMidi) {
            const opDefinitions = { "L": "Sensible", "P": "Paralela", "R": "Relativa", "N": "Vecina", "H": "Polo", "S": "Slide" };
            const opName = opDefinitions[op] || op;
            let html = op ? `<strong class="text-accent block mb-2 text-center text-xs border-b border-borderBase pb-1">Operaci√≥n: ${opName}</strong>` : "Selecciona una operaci√≥n.";
            if(from && to && fMidi && tMidi) {
                html += `<div class="mt-1 text-[10px] text-textMuted"><span class="block mb-1 font-normal text-center">(Clic en fila para escuchar)</span><div class="flex flex-col gap-1 mt-1 bg-bgPanel p-1 rounded border border-borderBase">`;
                const currentColors = ['#ef4444', '#16a34a', '#2563eb'];
                for(let i=0; i<fMidi.length; i++) {
                     const fm = fMidi[i]; const tm = tMidi[i];
                     const isCommon = (fm % 12) === (tm % 12);
                     const noteNameFrom = getNoteNameFromMidi(fm); const noteNameTo = getNoteNameFromMidi(tm);
                     const voiceColor = currentColors[i % currentColors.length];
                     html += `
                    <div class="voice-row flex justify-between p-0.5 cursor-pointer transition-colors" style="color:${voiceColor}" onclick="window.playVoiceLeading(${fm}, ${tm})" title="Reproducir: ${noteNameFrom} -> ${noteNameTo}">
                        <span class="${isCommon ? 'common-tone' : ''} w-1/3 text-right">${noteNameFrom}</span>
                        <span class="text-textMuted w-1/6 text-center">‚Üí</span>
                        <span class="${isCommon ? 'common-tone' : ''} w-1/3 text-left">${noteNameTo}</span>
                        <span class="w-1/6 text-[9px] text-textMuted text-right flex items-center justify-end">${isCommon ? 'ü§ù' : 'üîä'}</span>
                    </div>`;
                }
                html += `</div></div>`;
            }
            const opEl = getElement('operationExplanation'); if(opEl) opEl.innerHTML = html;
        }
        function addHistoryEntry(op, from, to, fMidi, tMidi) { if(currentHistoryIndex < history.length - 1) history = history.slice(0, currentHistoryIndex + 1); history.push({operation: op, from: from.name, to: to.name, fromMidi: fMidi, toMidi: tMidi}); currentHistoryIndex = history.length - 1; updateHistoryLog(); }
        function updateSetRelationshipsDisplay() {
             const hex = getHexatonicCycleForTriad(currentTriad); const wei = getWeitzmannRegionForTriad(currentTriad);
             const hexEl = getElement("currentHexatonicCycle"); if(hexEl) hexEl.textContent = hex ? hex.name : "-";
             const weiEl = getElement("currentWeitzmannRegion"); if(weiEl) weiEl.textContent = wei ? wei.name : "-";
        }
        function populateStartChordSelect() {
            const sel = document.getElementById("startChord"); if(!sel) return;
            sel.innerHTML = ''; const added = new Set();
            rootNamesByPreference[enharmonicPreference].forEach(r => { ["major", "minor"].forEach(t => { const tr = allTriads.find(x => x.root === r && x.type === t); if(tr && !added.has(tr.name)){ const o = document.createElement("option"); o.value = tr.name; o.textContent = tr.name; sel.appendChild(o); added.add(tr.name); } }) });
            if(currentTriad) sel.value = getPreferredSpelling(currentTriad).name;
        }

        // --- TEMA ---
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                html.classList.add('light');
                document.getElementById('themeToggleBtn').textContent = 'üåû';
            } else {
                html.classList.remove('light');
                html.classList.add('dark');
                document.getElementById('themeToggleBtn').textContent = 'üåô';
            }
            updateUI();
        }

        // --- KEYBOARD ---
        function renderKeyboard() {
            const container = getElement("pianoContainer"); if(!container) return;
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("width", "100%"); svg.setAttribute("height", "100%"); svg.setAttribute("viewBox", "0 0 350 80");
            const whiteKeyWidth = 16, blackKeyWidth = 10, blackKeyHeight = 50, whiteKeyHeight = 80;
            const startMidi = 48; // C3
            let x = 0; const whiteKeys = [], blackKeys = [];
            for(let m = startMidi; m <= 84; m++) {
                const pc = m % 12; const isBlack = [1,3,6,8,10].includes(pc);
                if(!isBlack) {
                    const r = document.createElementNS(svgNS, "rect");
                    r.setAttribute("x", x); r.setAttribute("y", 0); r.setAttribute("width", whiteKeyWidth); r.setAttribute("height", whiteKeyHeight);
                    r.setAttribute("class", "piano-key white"); r.dataset.midi = m;
                    whiteKeys.push(r); x += whiteKeyWidth;
                } else {
                    const r = document.createElementNS(svgNS, "rect");
                    r.setAttribute("x", x - (blackKeyWidth/2)); r.setAttribute("y", 0); r.setAttribute("width", blackKeyWidth); r.setAttribute("height", blackKeyHeight);
                    r.setAttribute("class", "piano-key black"); r.dataset.midi = m;
                    blackKeys.push(r);
                }
            }
            whiteKeys.forEach(k => svg.appendChild(k)); blackKeys.forEach(k => svg.appendChild(k));
            container.innerHTML = ""; container.appendChild(svg);
        }
        function highlightKeys(midiNotes) {
            document.querySelectorAll(".piano-key").forEach(k => k.classList.remove("active"));
            midiNotes.forEach(m => { const k = document.querySelector(`.piano-key[data-midi="${m}"]`); if(k) k.classList.add("active"); });
        }

        // --- VIZ UPDATES ---
        function updateCircleVisualization(act, prev) {
            const svg = document.querySelector("#hexatonicCircle svg"); if(!svg) return; svg.innerHTML = "";
            const cycle = (currentVisualizationMode==='rn'?weitzmannCycles:hexatonicCycles).find(c => c.members.some(m => m.hasSamePitchClasses(act) && m.type===act.type));
            
            const titleEl = document.getElementById("circleTitle");
            if(titleEl) {
                 titleEl.textContent = currentVisualizationMode === 'rn' ? "Regi√≥n de Weitzmann" : "C√≠rculo Hexat√≥nico";
            }

            if(!cycle) return;
            const cx = 150, cy = 150, r = 120;
            const labelsGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
            
            let rotationIndex = 0;
            const targetRoot = visualRotationRoot || act;
            
            if (targetRoot) {
                const foundIdx = cycle.members.findIndex(m => m.hasSamePitchClasses(targetRoot) && m.type === targetRoot.type);
                if (foundIdx !== -1) { rotationIndex = foundIdx; }
            }
            
            const rotationOffset = -(rotationIndex * 60);

            // Pole Line
            if(act) {
                const poleLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                const actIdx = cycle.members.findIndex(m => m.hasSamePitchClasses(act) && m.type===act.type);
                if(actIdx !== -1) {
                    const ang = (actIdx * 60 + rotationOffset - 90) * Math.PI / 180;
                    const x1 = cx + (r-35) * Math.cos(ang); const y1 = cy + (r-35) * Math.sin(ang);
                    const x2 = cx + (r-35) * Math.cos(ang + Math.PI); const y2 = cy + (r-35) * Math.sin(ang + Math.PI);
                    poleLine.setAttribute("x1", x1); poleLine.setAttribute("y1", y1); 
                    poleLine.setAttribute("x2", x2); poleLine.setAttribute("y2", y2);
                    poleLine.setAttribute("class", "pole-line");
                    svg.appendChild(poleLine);
                }
            }

            cycle.members.forEach((m, i) => {
                const ang = (i * 60 + rotationOffset - 90) * Math.PI / 180;
                const x = cx + r * Math.cos(ang), y = cy + r * Math.sin(ang);
                const isActive = (act && m.hasSamePitchClasses(act) && m.type===act.type);
                
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", x-30); rect.setAttribute("y", y-15); rect.setAttribute("width", 60); rect.setAttribute("height", 30);
                rect.setAttribute("rx", 5); 
                rect.setAttribute("class", isActive ? "node-base node-active" : "node-base");
                
                const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                txt.setAttribute("x", x); txt.setAttribute("y", y+5); txt.setAttribute("text-anchor", "middle");
                txt.setAttribute("class", isActive ? "node-text node-active-text" : "node-text");
                txt.textContent = getPreferredSpelling(m).name.replace(" Mayor","").replace(" menor","m");
                
                svg.appendChild(rect); svg.appendChild(txt);
                
                const nextIdx = (i + 1) % 6; 
                const nextAng = (nextIdx * 60 + rotationOffset - 90) * Math.PI / 180;
                const nextX = cx + r * Math.cos(nextAng), nextY = cy + r * Math.sin(nextAng);
                
                // Lines
                let dx = nextX - x; let dy = nextY - y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                let offsetX = (dx/dist) * 35; 
                let offsetY = (dy/dist) * 35;
                
                const path = document.createElementNS("http://www.w3.org/2000/svg", "line");
                path.setAttribute("x1", x + offsetX); path.setAttribute("y1", y + offsetY); 
                path.setAttribute("x2", nextX - offsetX); path.setAttribute("y2", nextY - offsetY);
                path.setAttribute("class", "line-connection"); 
                svg.insertBefore(path, rect);
                
                // Labels logic
                let opLabel = "";
                if(currentVisualizationMode === 'lp') opLabel = (i % 2 === 0) ? "L" : "P";
                else if(currentVisualizationMode === 'rn') opLabel = (i % 2 === 0) ? "R" : "N";

                if(opLabel) {
                    const midX = (x + nextX) / 2; const midY = (y + nextY) / 2;
                    const labelBg = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    labelBg.setAttribute("cx", midX); labelBg.setAttribute("cy", midY); labelBg.setAttribute("r", 8);
                    labelBg.setAttribute("class", "op-label-bg");
                    const labelTxt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    labelTxt.setAttribute("x", midX); labelTxt.setAttribute("y", midY+1); 
                    labelTxt.setAttribute("class", "op-label-text");
                    labelTxt.textContent = opLabel;
                    labelsGroup.appendChild(labelBg); labelsGroup.appendChild(labelTxt);
                }
            });
            svg.appendChild(labelsGroup);
        }

        function drawFullTonnetz() {
            const div = getElement("tonnetzVisualization"); if(!div) return; div.innerHTML = "";
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg"); svg.setAttribute("width", "100%"); svg.setAttribute("height", "100%");
            tonnetzNodesData.forEach(n => {
                tonnetzNodesData.forEach(n2 => {
                    const dx = Math.abs(n.x - n2.x), dy = Math.abs(n.y - n2.y);
                    if ((dx === 80 && dy === 0) || (dx === 40 && dy === 75)) {
                        const l = document.createElementNS(svgNS, "line");
                        l.setAttribute("x1", n.x + 40); l.setAttribute("y1", n.y + 40); l.setAttribute("x2", n2.x + 40); l.setAttribute("y2", n2.y + 40);
                        l.setAttribute("class", "line-connection"); svg.appendChild(l);
                    }
                });
            });
            tonnetzNodesData.forEach(n => {
                const g = document.createElementNS(svgNS, "g"); g.setAttribute("transform", `translate(${n.x+40},${n.y+40})`); g.dataset.pc = n.pc; g.classList.add("tonnetz-node-group");
                const c = document.createElementNS(svgNS, "circle"); c.setAttribute("r", 15); c.setAttribute("class", "tonnetz-node-circle node-base");
                const t = document.createElementNS(svgNS, "text"); t.textContent = n.note; t.setAttribute("text-anchor", "middle"); t.setAttribute("y", 5); t.setAttribute("class", "tonnetz-node-text node-text");
                g.appendChild(c); g.appendChild(t); svg.appendChild(g);
                g.onclick = () => highlightTonnetzByNote(n.pc);
            });
            svg.setAttribute("viewBox", "-150 -50 650 600"); 
            div.appendChild(svg);
        }

        function highlightTonnetzTriad(triad, prev) {
            document.querySelectorAll(".tonnetz-node-group circle").forEach(c => c.setAttribute("class", "tonnetz-node-circle node-base"));
            document.querySelectorAll(".tonnetz-node-group text").forEach(t => t.setAttribute("class", "tonnetz-node-text node-text"));
            if(prev) {
                prev.pitchClasses.forEach(pc => {
                    const nodes = document.querySelectorAll(`.tonnetz-node-group[data-pc="${pc}"] circle`);
                    nodes.forEach(c => c.classList.add("node-ghost"));
                });
            }
            if(triad) {
                triad.pitchClasses.forEach(pc => {
                    const nodes = document.querySelectorAll(`.tonnetz-node-group[data-pc="${pc}"]`);
                    nodes.forEach(g => {
                        g.querySelector("circle").classList.add("node-active");
                        g.querySelector("text").classList.add("node-active-text");
                    });
                });
            }
        }
        function highlightTonnetzByNote(pc) {
             const groups = document.querySelectorAll(".tonnetz-node-group");
             groups.forEach(g => {
                 const c = g.querySelector("circle");
                 const t = g.querySelector("text");
                 if(parseInt(g.dataset.pc) === pc) {
                     c.classList.add("node-active"); t.classList.add("node-active-text");
                 } else {
                     c.setAttribute("class", "tonnetz-node-circle node-base"); t.setAttribute("class", "tonnetz-node-text node-text");
                 }
             });
        }

        // --- QUIZ LOGIC ---
        function startQuiz() {
            isQuizMode = true;
            document.getElementById("quizContainer").classList.remove("hidden");
            document.getElementById("startQuizBtn").classList.add("hidden");
            generateQuizQuestion();
        }
        function stopQuiz() {
            isQuizMode = false;
            document.getElementById("quizContainer").classList.add("hidden");
            document.getElementById("startQuizBtn").classList.remove("hidden");
        }
        
        function generateQuizQuestion() {
            const startTriad = allTriads[Math.floor(Math.random() * allTriads.length)];
            const ops = ["L", "P", "R", "N", "S", "H"];
            const quizTargetOp = ops[Math.floor(Math.random() * ops.length)];
            
            let correctTriad;
            if(quizTargetOp==='L') correctTriad=opL(startTriad); 
            else if(quizTargetOp==='P') correctTriad=opP(startTriad); 
            else if(quizTargetOp==='R') correctTriad=opR(startTriad);
            else if(quizTargetOp==='N') correctTriad=opN(startTriad); 
            else if(quizTargetOp==='S') correctTriad=opS(startTriad); 
            else if(quizTargetOp==='H') correctTriad=opH(startTriad);
            
            quizTargetTriadName = correctTriad.name;
            const options = [correctTriad];
            while(options.length < 4) {
                const randomT = allTriads[Math.floor(Math.random() * allTriads.length)];
                if(!options.some(t => t.name === randomT.name)) { options.push(randomT); }
            }
            for (let i = options.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [options[i], options[j]] = [options[j], options[i]]; }
            
            document.getElementById("quizQuestion").innerHTML = `Aplique la transformaci√≥n <span class="text-accent font-bold">${quizTargetOp}</span> a <span class="font-bold">${startTriad.name}</span>`;
            document.getElementById("quizFeedback").textContent = "";
            const optsContainer = document.getElementById("quizOptions");
            optsContainer.innerHTML = "";
            options.forEach(opt => {
                const btn = document.createElement("button");
                btn.className = "quiz-btn p-2 rounded text-sm transition-colors";
                btn.textContent = opt.name;
                btn.onclick = () => checkQuizAnswer(btn, opt.name);
                optsContainer.appendChild(btn);
            });
            setStartChord(startTriad.name, true);
        }
        
        function checkQuizAnswer(btnElement, selectedName) {
            if(selectedName === quizTargetTriadName) {
                btnElement.classList.add("correct");
                document.getElementById("quizFeedback").innerHTML = `<span class="text-green-500 font-bold">¬°Correcto!</span>`;
                setTimeout(generateQuizQuestion, 1500);
            } else {
                btnElement.classList.add("wrong");
                document.getElementById("quizFeedback").innerHTML = `<span class="text-red-500 font-bold">Incorrecto. Intenta de nuevo.</span>`;
            }
        }

        // --- INICIALIZACI√ìN ---
        window.onload = () => {
            window.playVoiceLeading = playVoiceLeading;
            generateAllTriads(); genCycles(); populateStartChordSelect();
            setStartChord("C Mayor"); 
            renderKeyboard();
            
            getElement("startChord").onchange = (e) => setStartChord(e.target.value);
            getElement("resetButton").onclick = () => {
                setStartChord("C Mayor");
                const sel = getElement("startChord");
                if(sel) sel.value = "C Mayor";
            };
            getElement("enharmonicToggle").onchange = (e) => { enharmonicPreference = e.target.checked ? 'flat' : 'sharp'; generateAllTriads(); genCycles(); populateStartChordSelect(); setStartChord(currentTriad.name, true); };
            document.getElementById("themeToggleBtn").onclick = toggleTheme;
            
            document.querySelectorAll('button[data-op]').forEach(b => b.onclick = (e) => {
                const op = e.currentTarget.dataset.op; 
                if(isQuizMode) return;
                handleOperation(op);
            });

            document.getElementById("startQuizBtn").onclick = startQuiz;
            document.getElementById("stopQuizBtn").onclick = stopQuiz;

            function handleOperation(op) {
                if(isInAnalysisMode) return;
                let n; 
                if(op==='L') n=opL(currentTriad); else if(op==='P') n=opP(currentTriad); else if(op==='R') n=opR(currentTriad);
                else if(op==='N') n=opN(currentTriad); else if(op==='H') n=opH(currentTriad); else if(op==='S') n=opS(currentTriad);
                
                if(n) { 
                    const fM = lastPlayedVoicing.map(x=>Tone.Frequency(x).toMidi()); 
                    const tM = getSmartVoicing(fM, n); 
                    const p = currentTriad; currentTriad = n; 
                    addHistoryEntry(op, p, n, fM, tM); 
                    updateVoicing(tM); updateUI(); 
                    displayOperationExplanation(op, p, n, fM, tM); 
                    playProgression(fM, tM); 
                }
            }

            // Analysis
            getElement("analysisSelect").onchange = (e) => { if(e.target.value) startAnalysis(e.target.value); else exitAnalysis(); };
            getElement("exitAnalysisBtn").onclick = exitAnalysis;
            getElement("nextStepBtn").onclick = () => loadAnalysisStep(currentAnalysisStep+1);
            getElement("prevStepBtn").onclick = () => loadAnalysisStep(currentAnalysisStep-1);

            // Free Analysis
            getElement("freeAnalysisButton").onclick = () => {
                const txt = getElement("freeAnalysisInput").value;
                const names = txt.split(/[\s,]+/).filter(s=>s);
                if(names.length < 2) return;
                const t1 = getTriadByName(names[0]);
                if(!t1) { getElement("freeAnalysisError").textContent = "Acorde no reconocido."; return; }
                getElement("freeAnalysisError").textContent = "";
                exitAnalysis(); history=[]; currentHistoryIndex=-1; startAudioContext();
                currentTriad = t1; updateVoicing(t1.getNotes().map(n=>Tone.Frequency(n.replace('‚ôØ','#').replace('‚ô≠','b')+"4").toMidi())); updateUI();
                let curr = t1, cmidi = lastPlayedVoicing.map(x=>Tone.Frequency(x).toMidi());
                for(let i=1; i<names.length; i++){
                    const next = getTriadByName(names[i]); if(!next) continue;
                    const op = findBestOperation(curr, next); const tMidi = getSmartVoicing(cmidi, next);
                    addHistoryEntry(op, curr, next, cmidi, tMidi); curr = next; cmidi = tMidi;
                }
                currentTriad = curr; updateVoicing(cmidi); updateUI();
            };

            // Audio
            getElement("playChordButton").onclick = () => playVoicing(lastPlayedVoicing.map(x=>Tone.Frequency(x).toMidi()));
            getElement("playArpeggioButton").onclick = () => playArpeggio(lastPlayedVoicing.map(x=>Tone.Frequency(x).toMidi()));
            getElement("muteButton").onclick = () => { isMuted = !isMuted; getElement("muteButton").textContent = isMuted ? "üîá" : "üîä"; };
            getElement("vizToggle").onchange = (e) => { currentVisualizationMode = e.target.checked ? 'rn' : 'lp'; updateCircleVisualization(currentTriad, previousTriad); };

            // Modals
            getElement("glossaryButton").onclick = () => getElement("glossaryModal").classList.add("show");
            getElement("closeGlossaryButton").onclick = () => getElement("glossaryModal").classList.remove("show");
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
                    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                    const targetId = 'tab' + e.target.getAttribute('data-tab').charAt(0).toUpperCase() + e.target.getAttribute('data-tab').slice(1);
                    document.getElementById(targetId).classList.remove('hidden');
                    document.getElementById(targetId).classList.add('active');
                });
            });

            // Welcome
            const authorModal = getElement("authorModal");
            if (authorModal) { setTimeout(() => authorModal.classList.add("show"), 500); setTimeout(() => authorModal.classList.remove("show"), 3500); }

            // Shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
                const key = e.key.toLowerCase();
                
                if (key === 'e') {
                    document.getElementById('enharmonicToggle').click();
                }

                // New Shortcuts for V and D
                if (key === 'v') {
                    const vizToggle = document.getElementById('vizToggle');
                    if(vizToggle) {
                        vizToggle.checked = !vizToggle.checked;
                        // Trigger change event manually
                        const event = new Event('change');
                        vizToggle.dispatchEvent(event);
                    }
                }
                
                if (key === 'd') {
                    toggleTheme();
                }

                if (['l', 'p', 'r', 'n', 's', 'h'].includes(key)) {
                    if(isQuizMode) {
                        if(!checkQuizAnswer(key.toUpperCase())) return;
                    }
                    
                    const btn = document.querySelector(`button[data-op="${key.toUpperCase()}"]`);
                    if(btn) {
                        btn.classList.add('ring-4', 'ring-blue-300');
                        setTimeout(() => btn.classList.remove('ring-4', 'ring-blue-300'), 150);
                    }
                    handleOperation(key.toUpperCase());
                }

                // Audio
                if (key === ' ' || key === 'spacebar') { e.preventDefault(); document.getElementById('playChordButton').click(); }
                if (key === 'a') { document.getElementById('playArpeggioButton').click(); }
                if (key === 'm') { document.getElementById('muteButton').click(); }
                if (isInAnalysisMode) {
                    if (key === 'arrowright') document.getElementById('nextStepBtn').click();
                    if (key === 'arrowleft') document.getElementById('prevStepBtn').click();
                    if (key === 'escape') document.getElementById('exitAnalysisBtn').click();
                } else { if (key === 'backspace' || key === 'delete') { document.getElementById('resetButton').click(); } }
            });
        };
    </script>
</body>
</html>
