<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorador de Teoría Neo-Riemanniana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluir Tone.js para Web Audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; color: #334155; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 1.5rem; background-color: #ffffff; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn { @apply px-4 py-2 rounded-lg font-semibold transition-all duration-200 cursor-pointer; }
        .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-700 active:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 shadow-lg transform hover:scale-105; }
        .btn-secondary { @apply bg-gray-200 text-gray-800 hover:bg-gray-300 active:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 shadow-md transform hover:scale-105; }
        .btn:disabled { @apply bg-gray-300 text-gray-500 cursor-not-allowed transform-none shadow-none hover:bg-gray-300; }
        .btn-secondary.active-op-btn { @apply bg-yellow-400 text-gray-900 border-2 border-yellow-600 shadow-xl transform scale-105; }
        .btn-secondary.keyboard-active { @apply bg-blue-400 text-white transform scale-95 border-blue-500; }
        
        #operationsBox { transition: box-shadow 0.3s ease-in-out, border-color 0.3s ease-in-out; }
        #operationsBox.operations-box-active { box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5), 0 10px 20px -5px rgba(59, 130, 246, 0.3); border-color: #3b82f6; }
        .chord-display { @apply bg-blue-100 p-4 rounded-lg text-center my-4 border border-blue-200; }
        .explanation-box { @apply bg-green-50 p-4 rounded-lg text-sm my-4 border border-green-100; }
        
        .history-item { @apply bg-gray-50 p-2 rounded-md mb-2 text-sm border border-gray-100 cursor-pointer hover:bg-gray-100 transition-colors; }
        .history-item.active-history { @apply bg-yellow-100 border-yellow-300 font-medium; border-left: 4px solid #eab308; }
        .history-item.inactive-history { @apply opacity-50 bg-gray-100; }
        
        .non-diatonic-node { @apply opacity-40 grayscale; }
        .voice-leading-note { @apply font-mono; }
        .common-tone-note { @apply text-blue-600 font-bold; }
        .enharmonic-note { @apply text-indigo-700 border-b-2 border-dotted border-indigo-400 cursor-help transition-colors duration-200; }
        .enharmonic-note:hover { @apply bg-indigo-100 text-indigo-900 border-indigo-600; }
        
        .circle-container { position: relative; margin: 0 auto; border: 2px solid #cbd5e1; border-radius: 50%; display: flex; justify-content: center; align-items: center; background-color: #f8fafc; width: 100%; height: 100%; }
        .chord-node { position: absolute; width: 60px; height: 30px; background-color: #e2e8f0; border: 1px solid #94a3b8; border-radius: 0.5rem; display: flex; justify-content: center; align-items: center; font-size: 0.75rem; font-weight: bold; color: #475569; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chord-node.active { background-color: #3b82f6; color: white; border-color: #1d4ed8; box-shadow: 0 6px 12px -2px rgba(59, 130, 246, 0.4); animation: pulse 1.5s infinite alternate; }
        .chord-node.previous-active { background-color: #94a3b8; color: #e2e8f0; border-color: #64748b; opacity: 0.7; }
        @keyframes pulse { 0% { transform: scale(1); } 100% { transform: scale(1.03); } }
        .arrow { position: absolute; stroke: #94a3b8; stroke-width: 2; fill: none; marker-end: url(#arrowhead); pointer-events: none; }
        #arrowhead { fill: #94a3b8; }
        
        .tonnetz-node-circle { transition: fill 0.2s, stroke 0.2s; }
        .tonnetz-node-circle.active { fill: #3b82f6; stroke: #1d4ed8; stroke-width: 2px; }
        .tonnetz-node-circle.previous-active { fill: #94a3b8; stroke: #64748b; stroke-width: 1px; opacity: 0.7; }
        .tonnetz-node-text { transition: fill 0.2s; }
        .tonnetz-node-text.active { fill: white; font-weight: bold; }
        .tonnetz-triad-fill { transition: fill 0.2s; opacity: 0.4; }
        .tonnetz-triad-fill.active { fill: #3b82f6; }
        .tonnetz-triad-fill.previous-active { fill: #94a3b8; opacity: 0.3; }
        .tonnetz-transformation-path { stroke: #3b82f6; stroke-width: 3; fill: none; marker-end: url(#arrowhead-tonnetz); opacity: 0; animation: drawTonnetzPath 1s ease-out forwards; }
        @keyframes drawTonnetzPath { 0% { stroke-dasharray: 500; stroke-dashoffset: 500; opacity: 1; } 70% { stroke-dasharray: 500; stroke-dashoffset: 0; opacity: 1; } 100% { stroke-dasharray: 500; stroke-dashoffset: 0; opacity: 0; } }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-width: 90%; width: 600px; max-height: 85vh; overflow-y: auto; transform: translateY(-20px); transition: transform 0.3s ease; }
        .modal-overlay.show .modal-content { transform: translateY(0); }

        .tab-nav { @apply flex border-b border-gray-200 mb-4; }
        .tab-btn { @apply px-4 py-2 text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-300 transition-colors; }
        .tab-btn.active { @apply text-blue-600 border-blue-600 font-bold; }
        .tab-pane { @apply hidden; }
        .tab-pane.active { @apply block animate-fade-in; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }

        .toggle-switch-container { @apply flex items-center justify-center space-x-2 my-2; }
        .toggle-switch { @apply relative inline-block w-10 h-6; }
        .toggle-switch-input { @apply opacity-0 w-0 h-0; }
        .toggle-switch-slider { @apply absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-gray-300 rounded-full transition-all; }
        .toggle-switch-slider:before { @apply absolute content-[''] h-4 w-4 left-1 bottom-1 bg-white rounded-full transition-all; }
        .toggle-switch-input:checked + .toggle-switch-slider { @apply bg-blue-600; }
        .toggle-switch-input:checked + .toggle-switch-slider:before { transform: translateX(16px); }

        .viz-tab-container { @apply flex border-b border-gray-300 mb-4; }
        .viz-tab-btn { @apply px-4 py-2 -mb-px font-semibold text-gray-600 border-b-2 border-transparent hover:text-blue-600; }
        .viz-tab-btn.active { @apply text-blue-600 border-blue-600; }
        .viz-pane { @apply hidden; }
        .viz-pane.active { @apply block; }

        .btn-op-highlight-lp { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); border-color: #3b82f6; }
        .btn-op-highlight-rn { box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.5); border-color: #16a34a; }

        .analysis-explanation-box { @apply bg-yellow-50 p-4 rounded-lg text-sm my-4 border border-yellow-200 text-gray-800; }
        .analysis-score-container { @apply relative w-full mb-4; }
        .analysis-score-image { @apply w-full rounded-lg border-2 border-gray-300 shadow-md; }
        #analysisScoreMarker { @apply absolute border-4 border-red-500 rounded-md transition-all duration-500 ease-in-out; background-color: rgba(239, 68, 68, 0.3); pointer-events: none; opacity: 0; }
        #analysisScoreMarker.show { opacity: 1; }
        
        .audio-controls { @apply flex items-center gap-2 bg-gray-100 p-2 rounded-lg border border-gray-200 mt-2 text-sm; }
        .volume-slider { @apply w-24 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer; }
        .volume-slider::-webkit-slider-thumb { @apply appearance-none w-4 h-4 bg-blue-600 rounded-full cursor-pointer; }
        .hidden { display: none; }

        /* Footer Credits Centered */
        .credits-footer {
            @apply mt-8 pt-6 border-t border-gray-200 flex justify-center items-center text-sm text-gray-500;
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-6 text-blue-700">Explorador de Teoría Neo-Riemanniana</h1>

        <div class="flex flex-col md:flex-row gap-6">
            <!-- Panel Izquierdo -->
            <div class="md:w-1/2 flex flex-col">
                <div id="startChordContainer" class="mb-4 p-4 bg-gray-50 rounded-lg shadow-inner">
                    <label for="startChord" class="block text-gray-700 text-sm font-bold mb-2">Selecciona un acorde inicial:</label>
                    <select id="startChord" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400"></select>
                    <div class="toggle-switch-container mt-3">
                        <span class="toggle-switch-label">Preferir ♯</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="enharmonicToggle" class="toggle-switch-input">
                            <span class="toggle-switch-slider"></span>
                        </label>
                        <span class="toggle-switch-label">Preferir ♭</span>
                    </div>
                    <div class="audio-controls">
                        <span class="font-semibold text-gray-600">Sonido:</span>
                        <select id="waveTypeSelect" class="text-xs border border-gray-300 rounded px-1 py-1 bg-white">
                            <option value="triangle">Triángulo</option>
                            <option value="sine">Senoidal</option>
                            <option value="sawtooth">Sierra</option>
                            <option value="square">Cuadrada</option>
                        </select>
                        <span class="ml-2">Vol:</span>
                        <input type="range" id="volumeSlider" min="-30" max="0" value="-10" class="volume-slider">
                    </div>
                    <div class="flex gap-3 mt-3">
                        <button id="resetButton" class="btn btn-primary w-1/3">Reiniciar</button>
                        <button id="glossaryButton" class="btn btn-secondary w-1/3">Ayuda</button>
                        <button id="muteButton" class="btn btn-secondary w-1/3">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-volume-up-fill" viewBox="0 0 16 16"><path d="M11.536 14.01A8.47 8.47 0 0 0 14.026 8a8.47 8.47 0 0 0-2.49-6.01l-.707.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.198 5.303z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.89z"/><path d="M8.707 11.182A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.489 3.489 0 0 1 8 10.475zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06"/></svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">Atajos: L, P, R, N, S, H | Espacio: Play | A: Arpegio | Z: Deshacer</p>
                </div>

                <div class="mb-4 p-4 bg-gray-50 rounded-lg shadow-inner">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Análisis Guiado:</label>
                    <select id="analysisSelect" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="">Selecciona un análisis...</option>
                        <option value="liszt">Liszt - Consolación IV</option>
                        <option value="schubert">Schubert - D.946 Nº2</option>
                    </select>
                </div>

                <div id="analysisControls" class="hidden mb-4 p-4 bg-yellow-50 rounded-lg shadow-inner border border-yellow-200">
                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Análisis: <span id="analysisTitle"></span></h3>
                    <div class="toggle-switch-container mt-3 mb-3 bg-white p-2 rounded-lg border border-yellow-100">
                        <span class="toggle-switch-label">Preferir ♯</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="enharmonicToggleAnalysis" class="toggle-switch-input">
                            <span class="toggle-switch-slider"></span>
                        </label>
                        <span class="toggle-switch-label">Preferir ♭</span>
                    </div>
                    <div id="analysisScoreContainer" class="analysis-score-container hidden">
                        <img id="analysisScoreImage" src="" alt="Partitura" class="analysis-score-image">
                        <div id="analysisScoreMarker"></div>
                    </div>
                    <div id="analysisExplanation" class="analysis-explanation-box"></div>
                    <div class="flex justify-between gap-3 mt-3">
                        <button id="prevStepBtn" class="btn btn-secondary w-1/3">Anterior</button>
                        <button id="nextStepBtn" class="btn btn-secondary w-1/3">Siguiente</button>
                        <button id="exitAnalysisBtn" class="btn btn-primary w-1/3">Salir</button>
                    </div>
                </div>

                <!-- (Removed Diatonic Context) -->

                <div id="freeAnalysisContainer" class="mb-4 p-4 bg-gray-50 rounded-lg shadow-inner">
                    <label for="freeAnalysisInput" class="block text-gray-700 text-sm font-bold mb-2">Análisis Libre</label>
                    <textarea id="freeAnalysisInput" rows="3" class="shadow-sm border border-gray-300 rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Escribe una progresión, ej: DoM, Lam, FaM, DoM"></textarea>
                    <button id="freeAnalysisButton" class="btn btn-primary w-full mt-3">Analizar Progresión</button>
                    <p id="freeAnalysisError" class="text-red-600 text-sm mt-2"></p>
                </div>

                <div class="chord-display">
                    <div class="flex justify-center items-center gap-2">
                        <h2 class="text-xl font-bold text-blue-800">Acorde: <span id="currentChordName">C Mayor</span></h2>
                        <button id="playChordButton" class="btn btn-secondary p-2 leading-none" title="Play (Espacio)"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-volume-up-fill" viewBox="0 0 16 16"><path d="M11.536 14.01A8.47 8.47 0 0 0 14.026 8a8.47 8.47 0 0 0-2.49-6.01l-.707.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.198 5.303z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.89z"/><path d="M8.707 11.182A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.489 3.489 0 0 1 8 10.475zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06"/></svg></button>
                        <button id="playArpeggioButton" class="btn btn-secondary p-2 leading-none" title="Arpegio (A)"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-music-note-list" viewBox="0 0 16 16"><path d="M12 13c0 1.105-1.12 2-2.5 2S7 14.105 7 13s1.12-2 2.5-2 2.5.895 2.5 2"/><path fill-rule="evenodd" d="M12 3v10h-1V3z"/><path d="M11 2.82a1 1 0 0 1 .804-.98l3-.6A1 1 0 0 1 16 2.22V4l-5 1z"/><path fill-rule="evenodd" d="M0 11.5a.5.5 0 0 1 .5-.5H4a.5.5 0 0 1 0 1H.5a.5.5 0 0 1-.5-.5m0-4A.5.5 0 0 1 .5 7H8a.5.5 0 0 1 0 7.5m0-4A.5.5 0 0 1 .5 3H8a.5.5 0 0 1 0 1H.5A.5.5 0 0 1 0 3.5"/></svg></button>
                    </div>
                    <p class="text-lg text-gray-700">Notas: <span id="currentChordNotes"></span></p>
                </div>

                <div id="operationsBox" class="mb-4 p-4 bg-blue-50 rounded-lg shadow-inner border border-blue-100">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Operaciones:</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <button class="btn btn-secondary" data-op="L" title="Atajo: L">L (Leittonechel)</button>
                        <button class="btn btn-secondary" data-op="P" title="Atajo: P">P (Parallel)</button>
                        <button class="btn btn-secondary" data-op="R" title="Atajo: R">R (Relative)</button>
                        <button class="btn btn-secondary" data-op="N" title="Atajo: N">N (Next Related)</button>
                        <button class="btn btn-secondary" data-op="H" title="Atajo: H">H (Hexatonic Pole)</button>
                        <button class="btn btn-secondary" data-op="S" title="Atajo: S">S (Slide)</button>
                    </div>
                </div>

                <div class="explanation-box">
                    <div id="explanationTitleContainer"></div>
                    <p id="operationExplanation" class="text-gray-800">Selecciona una operación.</p>
                </div>

                <div class="p-4 bg-gray-50 rounded-lg shadow-inner mt-6">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Relación entre Conjuntos:</h3>
                    <div id="setRelationships" class="bg-white p-3 rounded-lg border border-gray-200 space-y-2">
                        <p><strong class="text-blue-700">Ciclo L/P:</strong> <span id="currentHexatonicCycle"></span></p>
                        <div id="hexatonicCycleMembers" class="flex flex-wrap gap-2 text-sm"></div>
                        <p><strong class="text-green-700">Región R/N:</strong> <span id="currentWeitzmannRegion"></span></p>
                        <div id="weitzmannRegionMembers" class="flex flex-wrap gap-2 text-sm"></div>
                    </div>
                </div>

                <div class="p-4 bg-gray-50 rounded-lg shadow-inner mt-6 flex-grow">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Historial:</h3>
                    <div id="historyLog" class="h-60 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-white"></div>
                </div>
            </div>

            <!-- Panel Derecho -->
            <div class="md:w-1/2 flex flex-col">
                <div class="viz-tab-container">
                    <button id="tabBtnCircle" class="viz-tab-btn active" data-viz="circle">Círculo</button>
                    <button id="tabBtnTonnetz" class="viz-tab-btn" data-viz="tonnetz">Tonnetz</button>
                </div>
                <div id="vizPaneCircle" class="viz-pane active">
                    <div class="p-4 flex flex-col items-center bg-white rounded-lg shadow-inner h-[450px]">
                        <h3 id="circleTitle" class="text-lg font-semibold mb-3 text-gray-800">Visualización</h3>
                        <div class="toggle-switch-container">
                            <span class="toggle-switch-label">L/P</span>
                            <label class="toggle-switch"><input type="checkbox" id="vizToggle" class="toggle-switch-input"><span class="toggle-switch-slider"></span></label>
                            <span class="toggle-switch-label">R/N</span>
                        </div>
                        <div id="hexatonicCircle" class="circle-container"><svg width="100%" height="100%" viewBox="0 0 300 300"></svg></div>
                    </div>
                </div>
                <div id="vizPaneTonnetz" class="viz-pane">
                    <div class="p-4 bg-white rounded-lg shadow-inner h-[450px] flex flex-col items-center">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Visualización del Tonnetz</h3>
                        <div id="tonnetzVisualization" class="w-full h-full border border-gray-200 rounded-lg"></div>
                        <p class="text-xs text-gray-500 mt-2">Haz clic en una nota para resaltar tríadas.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="credits-footer">Realizado por: <span class="font-bold text-gray-700 ml-1">Juan Miguel Ríos Redondo</span></div>
    </div>

    <!-- Modales -->
    <div id="glossaryModal" class="modal-overlay">
        <div class="modal-content text-left">
            <h2 class="text-2xl font-bold text-blue-700 mb-4 text-center">Ayuda</h2>
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="operaciones">Operaciones</button>
                <button class="tab-btn" data-tab="conceptos">Conceptos</button>
            </div>
            <div id="tabOperaciones" class="tab-pane active">
                <div class="space-y-4 text-sm text-gray-700">
                    <div><strong class="text-blue-600 text-base block mb-1">P (Parallel)</strong>Relaciona una tríada mayor con su homónima menor (ej. Do Mayor ↔ Do menor). Mueve la tercera un semitono.</div>
                    <div><strong class="text-blue-600 text-base block mb-1">L (Leittonwechsel)</strong>Intercambio de sensible. Relaciona tríadas que comparten la tercera mayor y menor (ej. Do Mayor ↔ Mi menor). Mueve la fundamental un semitono.</div>
                    <div><strong class="text-blue-600 text-base block mb-1">R (Relative)</strong>Relaciona una tríada con su relativa (ej. Do Mayor ↔ La menor). Mueve la quinta un tono.</div>
                    <div><strong class="text-green-600 text-base block mb-1">N (Nebenverwandt)</strong>Relación de vecindad. Intercambia una tríada mayor por su subdominante menor (ej. C ↔ Fm). Es compuesta (R-L-P).</div>
                    <div><strong class="text-green-600 text-base block mb-1">S (Slide)</strong>Deslizamiento. Comparte la tercera pero cambia el modo (ej. C ↔ C#m). Es compuesta (L-P-R).</div>
                    <div><strong class="text-green-600 text-base block mb-1">H (Hexatonic Pole)</strong>Polo hexatónico. Conecta una tríada con su opuesta en el ciclo hexatónico (ej. C ↔ Abm). Es compuesta (L-P-L).</div>
                </div>
            </div>
            <div id="tabConceptos" class="tab-pane">
                <div class="space-y-4 text-sm text-gray-700">
                    <div><h4 class="font-bold text-gray-900 text-base">Involución</h4><p>Una operación que es su propio inverso. Al aplicarla dos veces consecutivas, se vuelve al punto de partida (ej. P, L, R).</p></div>
                    <div><h4 class="font-bold text-gray-900 text-base">Conducción Idealizada</h4><p>Aquella conducción en la que los acordes se disponen de manera tal que cada voz se desplace la menor distancia posible (semitono o tono), manteniendo fijas las notas en común.</p></div>
                    <div><h4 class="font-bold text-gray-900 text-base">Ciclo Hexatónico</h4><p>Un conjunto de seis tríadas (tres mayores y tres menores) generado por el encadenamiento alterno de las operaciones L y P.</p></div>
                    <div><h4 class="font-bold text-gray-900 text-base">Región de Weitzmann</h4><p>Un conjunto de seis tríadas generado por el encadenamiento alterno de las operaciones R y N.</p></div>
                    <div><h4 class="font-bold text-gray-900 text-base">Tonnetz</h4><p>Red de relaciones tonales que visualiza la proximidad armónica y la estructura interválica de los acordes.</p></div>
                </div>
            </div>
            <button id="closeGlossaryButton" class="btn btn-primary w-full mt-6">Cerrar</button>
        </div>
    </div>
    <div id="authorModal" class="modal-overlay">
        <div class="modal-content text-center"><p class="text-gray-800 text-lg">Realizado por:</p><p class="text-blue-600 text-2xl font-bold mt-2">Juan Miguel Ríos Redondo</p></div>
    </div>

    <script>
        // Global Vars
        let currentTriad, previousTriad = null, history = [], currentHistoryIndex = -1;
        let hexatonicCycles = [], weitzmannCycles = [];
        let currentVisualizationMode = 'lp', isInAnalysisMode = false, currentAnalysis = null, currentAnalysisStep = 0;
        let enharmonicPreference = 'sharp';
        let isToneStarted = false, isMuted = false, lastPlayedVoicing = [], currentTonnetzHighlight = null;

        // Tone
        const synth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" }, envelope: { attack: 0.05, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
        const arpeggioSynth = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.05, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();

        // Data
        const noteToPitchClass = { "C":0, "C♯":1, "D♭":1, "D":2, "D♯":3, "E♭":3, "E":4, "F":5, "F♯":6, "G♭":6, "G":7, "G♯":8, "A♭":8, "A":9, "A♯":10, "B♭":10, "B":11, "E♯":5, "B♯":0, "C♭":11, "F♭":4, "Gx":9, "Ax":11 };
        const canonicalSpelling = {
            sharp: { 0:"C", 1:"C♯", 2:"D", 3:"D♯", 4:"E", 5:"F", 6:"F♯", 7:"G", 8:"G♯", 9:"A", 10:"A♯", 11:"B" },
            flat:  { 0:"C", 1:"D♭", 2:"D", 3:"E♭", 4:"E", 5:"F", 6:"G♭", 7:"G", 8:"A♭", 9:"A", 10:"B♭", 11:"B" }
        };
        const allPossibleRootNames = ["C", "C♯", "D♭", "D", "D♯", "E♭", "E", "F", "F♯", "G♭", "G", "G♯", "A♭", "A", "A♯", "B♭", "B"];
        const rootNamesByPreference = {
            sharp: ["C", "C♯", "D", "D♯", "E", "F", "F♯", "G", "G♯", "A", "A♯", "B"],
            flat:  ["C", "D♭", "D", "E♭", "E", "F", "G♭", "G", "A♭", "A", "B♭", "B"]
        };
        
        // Tonnetz data - Vertical spacing increased (Y values)
        const tonnetzNodesData = [
            { note: "D♯", pc: 3, x: 0, y: 0 }, { note: "A♯", pc: 10, x: 80, y: 0 }, { note: "E♯", pc: 5, x: 160, y: 0 }, { note: "B♯", pc: 0, x: 240, y: 0 }, { note: "Gx", pc: 9, x: 320, y: 0 },
            { note: "B", pc: 11, x: -40, y: 75 }, { note: "F♯", pc: 6, x: 40, y: 75 }, { note: "C♯", pc: 1, x: 120, y: 75 }, { note: "G♯", pc: 8, x: 200, y: 75 }, { note: "D♯", pc: 3, x: 280, y: 75 }, { note: "A♯", pc: 10, x: 360, y: 75 },
            { note: "D", pc: 2, x: 0, y: 150 }, { note: "A", pc: 9, x: 80, y: 150 }, { note: "E", pc: 4, x: 160, y: 150 }, { note: "B", pc: 11, x: 240, y: 150 }, { note: "F♯", pc: 6, x: 320, y: 150 }, { note: "C♯", pc: 1, x: 400, y: 150 },
            { note: "B♭", pc: 10, x: -40, y: 225 }, { note: "F", pc: 5, x: 40, y: 225 }, { note: "C", pc: 0, x: 120, y: 225 }, { note: "G", pc: 7, x: 200, y: 225 }, { note: "D", pc: 2, x: 280, y: 225 }, { note: "A", pc: 9, x: 360, y: 225 },
            { note: "D♭", pc: 1, x: 0, y: 300 }, { note: "A♭", pc: 8, x: 80, y: 300 }, { note: "E♭", pc: 3, x: 160, y: 300 }, { note: "B♭", pc: 10, x: 240, y: 300 }, { note: "F", pc: 5, x: 320, y: 300 }, { note: "C", pc: 0, x: 400, y: 300 },
            { note: "F♭", pc: 4, x: 40, y: 375 }, { note: "C♭", pc: 11, x: 120, y: 375 }, { note: "G♭", pc: 6, x: 200, y: 375 }, { note: "D♭", pc: 1, x: 280, y: 375 }, { note: "A♭", pc: 8, x: 360, y: 375 },
            { note: "B", pc: 11, x: -40, y: 375 }, { note: "E", pc: 4, x: 40, y: 375 }
        ];
        
        const analysisData = {
            'liszt': { name: "Liszt - Consolación IV", imageUrl: "https://github.com/juanmiguel0927/TeoriaNeo-Riemanniana/raw/237988f08d9cfcc051ba15127077478eb15c7828/Liszt.png", steps: [ { chord: 'B♭ menor', op: null, text: "Compás 20. Inicio en Si♭m." }, { chord: 'D♭ Mayor', op: 'R', text: "Compás 21. B♭m → D♭M." }, { chord: 'D♭ menor', op: 'P', text: "Compás 21. D♭M → D♭m." }, { chord: 'E Mayor', op: 'R', text: "Compás 22. D♭m → EM." }, { chord: 'E menor', op: 'P', text: "Compás 22. EM → Em." }, { chord: 'G menor', op: null, text: "Compás 23. Em → Gm." } ] },
            'schubert': { name: "Schubert - D.946 Nº2", imageUrl: "https://raw.githubusercontent.com/juanmiguel0927/TeoriaNeo-Riemanniana/237988f08d9cfcc051ba15127077478eb15c7828/Schubert.png", steps: [ { chord: 'D menor', op: null, text: "Compás 46. Inicio en Dm." }, { chord: 'A Mayor', op: 'N', text: "Compás 48. Dm → AM." }, { chord: 'F menor', op: 'H', text: "Compás 49. AM → Fm." }, { chord: 'C Mayor', op: 'N', text: "Compás 51. Fm → CM." }, { chord: 'A♭ menor', op: 'H', text: "Compás 52. CM → A♭m." } ] }
        };
        const explanations = { "L":"L (Leittonechel): Mueve una voz por semitono.","P":"P (Parallel): Relativa menor/mayor.","R":"R (Relative): Relativa diatónica.","N":"N (Nebenverwandt): Vecina relacionada.","H":"H (Hexatonic Pole): Polo opuesto.","S":"S (Slide): Deslizamiento semitonal." };

        // --- UTILS ---
        function normalizePitch(pc) { return (pc % 12 + 12) % 12; }
        function getNoteNameFromMidi(midi, pref = enharmonicPreference) { return canonicalSpelling[pref][normalizePitch(midi)] + (Math.floor(midi/12)-1); }
        function getAlternateSpelling(midi) { const altPref = (enharmonicPreference === 'sharp') ? 'flat' : 'sharp'; const curr = canonicalSpelling[enharmonicPreference][normalizePitch(midi)]; const alt = canonicalSpelling[altPref][normalizePitch(midi)]; return (curr !== alt) ? getNoteNameFromMidi(midi, altPref) : null; }
        function hasEnharmonic(midi) { return canonicalSpelling['sharp'][normalizePitch(midi)] !== canonicalSpelling['flat'][normalizePitch(midi)]; }
        function getElement(id) { const el = document.getElementById(id); if(!el) console.warn("Missing:", id); return el; }
        function safeClassListRemove(id, cls) { const el = getElement(id); if(el) el.classList.remove(cls); }
        function safeClassListAdd(id, cls) { const el = getElement(id); if(el) el.classList.add(cls); }

        class Triad {
            constructor(root, type) { this.root = root; this.type = type; this.pitchClasses = this.calcPC(); this.name = `${root} ${type === 'major' ? 'Mayor' : 'menor'}`; }
            calcPC() { const r = noteToPitchClass[this.root]; return (this.type==='major'?[r, normalizePitch(r+4), normalizePitch(r+7)]:[r, normalizePitch(r+3), normalizePitch(r+7)]).sort((a,b)=>a-b); }
            getNotes() { const r=noteToPitchClass[this.root]; const t=(this.type==='major')?normalizePitch(r+4):normalizePitch(r+3); const f=normalizePitch(r+7); const s=(pc)=>canonicalSpelling[enharmonicPreference][pc]; return [this.root, s(t), s(f)]; }
            hasSamePitchClasses(o) { return this.pitchClasses.every((p,i)=>p===o.pitchClasses[i]); }
        }

        let allTriads = [];
        function generateAllTriads() { allTriads = []; const added = new Set(); allPossibleRootNames.forEach(r => { ["major", "minor"].forEach(t => { const tr = new Triad(r, t); if(!added.has(tr.name)){ allTriads.push(tr); added.add(tr.name); } }) }); }
        function getTriadByName(n) { if(!n)return null; let nm = n.trim().replace(/b/g,'♭').replace(/#/g,'♯'); let type = (nm.toLowerCase().includes("m") && !nm.includes("Mayor")) ? "minor" : "major"; nm = nm.replace(/menor|major|mayor|m/gi, '').trim(); let r = nm.charAt(0).toUpperCase() + nm.slice(1); return allTriads.find(t=>t.name===`${r} ${type==='major'?'Mayor':'menor'}`); }
        function getPreferredSpelling(t) { if(!t)return null; const r = noteToPitchClass[t.root]; const pr = canonicalSpelling[enharmonicPreference][r]; return allTriads.find(x=>x.root===pr && x.type===t.type)||t; }
        function findTriadByPitchClasses(pcs, type) { const s = [...pcs].sort((a,b)=>a-b); return allTriads.find(t=>t.type===type && t.pitchClasses.every((p,i)=>p===s[i])) || null; }

        function opL(t) { const r = noteToPitchClass[t.root]; return t.type==='major' ? findTriadByPitchClasses([normalizePitch(r+4),normalizePitch(r+7),normalizePitch(r-1)], 'minor') : findTriadByPitchClasses([normalizePitch(r+7+1),r,normalizePitch(r+3)], 'major'); }
        function opP(t) { const r = noteToPitchClass[t.root]; return t.type==='major' ? findTriadByPitchClasses([r,normalizePitch(r+3),normalizePitch(r+7)], 'minor') : findTriadByPitchClasses([r,normalizePitch(r+4),normalizePitch(r+7)], 'major'); }
        function opR(t) { const r = noteToPitchClass[t.root]; return t.type==='major' ? findTriadByPitchClasses([normalizePitch(r-3),r,normalizePitch(r+4)], 'minor') : findTriadByPitchClasses([normalizePitch(r+3),normalizePitch(r+7),normalizePitch(r+10)], 'major'); }
        function opN(t) { const r = noteToPitchClass[t.root]; return t.type==='major' ? findTriadByPitchClasses([normalizePitch(r+5),normalizePitch(r+8),r], 'minor') : findTriadByPitchClasses([normalizePitch(r+7),normalizePitch(r-1),normalizePitch(r+2)], 'major'); }
        function opH(t) { let p=opP(t); if(!p)return null; let l=opL(p); if(!l)return null; return opP(l); }
        function opS(t) { let r=opR(t); if(!r)return null; let n=opN(r); if(!n)return null; return opR(n); }
        function findBestOperation(a, b) { if(opP(a)&&opP(a).hasSamePitchClasses(b)) return 'P'; if(opL(a)&&opL(a).hasSamePitchClasses(b)) return 'L'; if(opR(a)&&opR(a).hasSamePitchClasses(b)) return 'R'; if(opN(a)&&opN(a).hasSamePitchClasses(b)) return 'N'; if(opS(a)&&opS(a).hasSamePitchClasses(b)) return 'S'; if(opH(a)&&opH(a).hasSamePitchClasses(b)) return 'H'; return '??'; }

        function genCycles() {
            const start = canonicalSpelling[enharmonicPreference];
            hexatonicCycles = []; weitzmannCycles = [];
            [0,1,2,3].forEach(i => {
                let c = [], curr = getTriadByName(`${start[i]} Mayor`);
                for(let k=0;k<6;k++) { if(curr) c.push(curr); curr=(k%2===0)?opL(curr):opP(curr); }
                hexatonicCycles.push({name: `Ciclo ${i+1}`, members: c.filter(Boolean)});
                c = []; curr = getTriadByName(`${start[i]} Mayor`);
                for(let k=0;k<6;k++) { if(curr) c.push(curr); curr=(k%2===0)?opR(curr):opN(curr); }
                weitzmannCycles.push({name: `Región ${i+1}`, members: c.filter(Boolean)});
            });
        }
        
        function getHexatonicCycleForTriad(triad) { if (!triad) return null; return hexatonicCycles.find(cycle => cycle.members.some(member => member.hasSamePitchClasses(triad) && member.type === triad.type)); }
        function getWeitzmannRegionForTriad(triad) { if (!triad) return null; return weitzmannCycles.find(cycle => cycle.members.some(member => member.hasSamePitchClasses(triad) && member.type === triad.type)); }

        // --- CORE LOGIC ---
        function exitAnalysis() {
            isInAnalysisMode = false; currentAnalysis = null;
            safeClassListAdd("analysisControls", "hidden");
            safeClassListRemove("startChordContainer", "hidden");
            safeClassListRemove("operationsBox", "hidden");
            safeClassListRemove("freeAnalysisContainer", "hidden");
            history = []; currentHistoryIndex = -1; updateHistoryLog();
        }
        function startAnalysis(key) {
            isInAnalysisMode = true; currentAnalysis = analysisData[key]; currentAnalysisStep = 0;
            const t = getElement("analysisTitle"); if(t) t.textContent = currentAnalysis.name;
            const img = getElement("analysisScoreImage"); if(img) img.src = currentAnalysis.imageUrl;
            safeClassListRemove("analysisControls", "hidden");
            safeClassListRemove("analysisScoreContainer", "hidden");
            safeClassListAdd("startChordContainer", "hidden");
            safeClassListAdd("operationsBox", "hidden");
            safeClassListAdd("freeAnalysisContainer", "hidden");
            loadAnalysisStep(0);
        }
        function loadAnalysisStep(idx) {
            if (!currentAnalysis || idx < 0 || idx >= currentAnalysis.steps.length) return;
            currentAnalysisStep = idx;
            const step = currentAnalysis.steps[idx];
            const newTriad = getPreferredSpelling(getTriadByName(step.chord));
            const prevStep = (idx > 0) ? currentAnalysis.steps[idx - 1] : null;
            const oldTriad = prevStep ? getPreferredSpelling(getTriadByName(prevStep.chord)) : null;
            previousTriad = oldTriad; currentTriad = newTriad;
            startAudioContext();
            let fMidi, tMidi;
            if (oldTriad) {
                fMidi = lastPlayedVoicing.map(n => Tone.Frequency(n).toMidi());
                tMidi = getClosestVoicing(fMidi, newTriad);
                updateVoicing(tMidi);
            } else {
                tMidi = newTriad.getNotes().map(n => Tone.Frequency(n.replace('♯','#').replace('♭','b')+"4").toMidi());
                fMidi = tMidi; updateVoicing(tMidi);
            }
            updateUI();
            displayOperationExplanation(step.op || "Siguiente", oldTriad, newTriad, fMidi, tMidi);
            const desc = getElement("operationExplanation");
            if(desc) desc.innerHTML = `<p class="mb-2 font-semibold">${step.text}</p>` + desc.innerHTML;
            if (step.marker) { const m = getElement("analysisScoreMarker"); if(m) { m.style.top=step.marker.top; m.style.left=step.marker.left; m.style.width=step.marker.width; m.style.height=step.marker.height; m.classList.add('show'); } }
            if (idx > 0) addHistoryEntry(step.op || "Siguiente", oldTriad, newTriad, fMidi, tMidi); else { history=[]; currentHistoryIndex=-1; updateHistoryLog(); }
            const prevBtn = getElement("prevStepBtn"); if(prevBtn) prevBtn.disabled = (idx === 0);
            const nextBtn = getElement("nextStepBtn"); if(nextBtn) nextBtn.disabled = (idx === currentAnalysis.steps.length - 1);
        }
        function setStartChord(name, preserve) {
            if(!preserve) exitAnalysis();
            currentTriad = getPreferredSpelling(getTriadByName(name) || allTriads[0]);
            if(!preserve) { history=[]; currentHistoryIndex=-1; previousTriad=null; updateVoicing(currentTriad.getNotes().map(n=>Tone.Frequency(n.replace('♯','#').replace('♭','b')+"4").toMidi())); }
            updateUI(); if(!preserve) displayOperationExplanation('');
            safeClassListRemove("operationsBox", "operations-box-active");
        }

        // --- UI UPDATES ---
        async function startAudioContext() { if(!isToneStarted){ await Tone.start(); isToneStarted=true; } }
        function updateVoicing(m) { lastPlayedVoicing = m.map(x=>Tone.Frequency(x,"midi").toNote()); }
        function playVoicing(m) { if(isMuted)return; startAudioContext(); updateVoicing(m); synth.triggerAttackRelease(lastPlayedVoicing, "1s"); }
        function playArpeggio(m) { if(isMuted)return; startAudioContext(); [...m].sort((a,b)=>a-b).map(x=>Tone.Frequency(x,"midi").toNote()).forEach((n,i)=>arpeggioSynth.triggerAttackRelease(n, "8n", Tone.now()+i*0.15)); }
        function getClosestVoicing(fromMidi, toTriad) {
            const tPcs = toTriad.pitchClasses; let rem = [...tPcs], newV = [], used = [];
            fromMidi.forEach(m => { const idx = rem.indexOf(m%12); if(idx!==-1) { newV.push(m); rem.splice(idx,1); used.push(m); } });
            fromMidi.filter(m=>!used.includes(m)).forEach(m => {
                let best = 0, dist = Infinity, bIdx = -1;
                rem.forEach((pc, i) => { const bo = Math.floor(m/12); [bo*12+pc, (bo-1)*12+pc, (bo+1)*12+pc].forEach(cand => { if(Math.abs(cand-m)<dist){ dist=Math.abs(cand-m); best=cand; bIdx=i; } }); });
                newV.push(best); rem.splice(bIdx,1);
            });
            return newV;
        }

        function updateUI() {
            if(!currentTriad) return;
            currentTriad = getPreferredSpelling(currentTriad);
            const notes = currentTriad.getNotes(), pcs = currentTriad.pitchClasses;
            const nm = getElement("currentChordName"); if(nm) nm.textContent = currentTriad.name;
            const createSpan = (n, pc) => {
                const alt = canonicalSpelling[enharmonicPreference==='sharp'?'flat':'sharp'][pc];
                const has = (n !== alt);
                return `<span class="font-bold ${has?'enharmonic-note':''}" data-current="${n}" ${has?`data-alternate="${alt}"`:''}>${n}</span>`;
            };
            const cn = getElement("currentChordNotes");
            if(cn) cn.innerHTML = `Raíz: ${createSpan(notes[0], pcs[0])}, Tercera: ${createSpan(notes[1], pcs[1])}, Quinta: ${createSpan(notes[2], pcs[2])}`;
            updateHistoryLog(); updateSetRelationshipsDisplay(); updateCircleVisualization(currentTriad, previousTriad); drawFullTonnetz(); highlightTonnetzTriad(currentTriad, previousTriad);
        }
        function updateHistoryLog() {
            const log = getElement("historyLog"); if(!log) return; log.innerHTML = "";
            [...history].reverse().forEach((h, i) => {
                const div = document.createElement("div");
                div.className = `history-item ${history.length-1-i===currentHistoryIndex?'active-history':'inactive-history'}`;
                div.textContent = `${h.timestamp}: ${h.from} --(${h.operation})--> ${h.to}`;
                div.onclick = () => { 
                    if(isInAnalysisMode) {
                        const targetStep = (history.length - 1 - i) + 1;
                        loadAnalysisStep(targetStep);
                    } else {
                        currentHistoryIndex = history.length-1-i; 
                        currentTriad = getTriadByName(h.to); 
                        updateVoicing(h.toMidi); 
                        updateUI(); 
                        displayOperationExplanation(h.operation, getTriadByName(h.from), currentTriad, h.fromMidi, h.toMidi); 
                    }
                };
                log.appendChild(div);
            });
        }
        function displayOperationExplanation(op, from, to, fMidi, tMidi) {
            let html = explanations[op] || "Selecciona una operación.";
            let title = `<h3 class="text-lg font-semibold mb-2 text-green-800 inline-block">Explicación:</h3>`;
            if(from && to && fMidi && tMidi) {
                title = `<h3 class='text-lg font-semibold mb-2 text-green-800 inline-block'>Conducción de Voces (Voicing):</h3>
                         <button id="playVoiceLeadingBtn" class="btn btn-secondary p-1 leading-none inline-block ml-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-circle-fill" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M6.79 5.093A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814z"/></svg></button>`;
                const common = fMidi.map(m=>m%12).filter(p => tMidi.map(x=>x%12).includes(p));
                let list = "<ul class='list-disc list-inside mt-1'>";
                fMidi.forEach((fm, i) => {
                    const tm = tMidi[i];
                    const fn = getNoteNameFromMidi(fm), tn = getNoteNameFromMidi(tm);
                    const fAlt = getAlternateSpelling(fm), tAlt = getAlternateSpelling(tm);
                    const isCom = common.includes(fm%12) && (Math.abs(fm-tm)<0.1);
                    const fSpan = `<span class="voice-leading-note ${fAlt?'enharmonic-note':''}" data-current="${fn}" ${fAlt?`data-alternate="${fAlt}"`:''}>${fn}</span>`;
                    const tSpan = `<span class="voice-leading-note ${tAlt?'enharmonic-note':''}" data-current="${tn}" ${tAlt?`data-alternate="${tAlt}"`:''}>${tn}</span>`;
                    list += `<li class="${isCom?'common-tone-note':''}">${fSpan} → ${tSpan} ${isCom?'(Nota Común)':''}</li>`;
                });
                html = list + "</ul>";
            }
            const titleEl = getElement('explanationTitleContainer'); if(titleEl) titleEl.innerHTML = title;
            const opEl = getElement('operationExplanation'); if(opEl) opEl.innerHTML = html;
            const btn = getElement('playVoiceLeadingBtn');
            if(btn) btn.addEventListener('click', (e)=>{e.stopPropagation(); if(!isMuted){startAudioContext(); const now=Tone.now(); synth.triggerAttackRelease(fMidi.map(x=>Tone.Frequency(x,"midi").toNote()), "0.8s", now); synth.triggerAttackRelease(tMidi.map(x=>Tone.Frequency(x,"midi").toNote()), "0.8s", now+0.9);}});
        }
        function toggleEnharmonicSpan(span) { if(span && span.classList.contains('enharmonic-note')) { const c = span.dataset.current, a = span.dataset.alternate; if(a) span.textContent = (span.textContent === c) ? a : c; } }
        function addHistoryEntry(op, from, to, fMidi, tMidi) { if(currentHistoryIndex < history.length - 1) history = history.slice(0, currentHistoryIndex + 1); history.push({operation: op, from: from.name, to: to.name, fromMidi: fMidi, toMidi: tMidi, timestamp: new Date().toLocaleTimeString()}); currentHistoryIndex = history.length - 1; updateHistoryLog(); }
        function updateSetRelationshipsDisplay() {
             const hex = getHexatonicCycleForTriad(currentTriad); const wei = getWeitzmannRegionForTriad(currentTriad);
             const hexEl = getElement("currentHexatonicCycle"); if(hexEl) hexEl.textContent = hex ? hex.name : "-";
             const hexM = getElement("hexatonicCycleMembers"); if(hexM) hexM.innerHTML = hex ? hex.members.map(m=>`<span class="bg-blue-100 px-1 rounded">${getPreferredSpelling(m).name}</span>`).join(" ") : "";
             const weiEl = getElement("currentWeitzmannRegion"); if(weiEl) weiEl.textContent = wei ? wei.name : "-";
             const weiM = getElement("weitzmannRegionMembers"); if(weiM) weiM.innerHTML = wei ? wei.members.map(m=>`<span class="bg-green-100 px-1 rounded">${getPreferredSpelling(m).name}</span>`).join(" ") : "";
        }
        function populateStartChordSelect() {
            const sel = document.getElementById("startChord"); if(!sel) return;
            sel.innerHTML = ''; const added = new Set();
            rootNamesByPreference[enharmonicPreference].forEach(r => { ["major", "minor"].forEach(t => { const tr = allTriads.find(x => x.root === r && x.type === t); if(tr && !added.has(tr.name)){ const o = document.createElement("option"); o.value = tr.name; o.textContent = tr.name; sel.appendChild(o); added.add(tr.name); } }) });
            if(currentTriad) sel.value = getPreferredSpelling(currentTriad).name;
        }
        function highlightActiveOperation(op) {
            document.querySelectorAll('#operationsBox button').forEach(b=>b.classList.remove('active-op-btn'));
            const btn = document.querySelector(`button[data-op="${op}"]`);
            if(btn) btn.classList.add('active-op-btn');
        }
        function removeActiveOperationHighlight() { document.querySelectorAll('#operationsBox button').forEach(b=>b.classList.remove('active-op-btn')); }
        function removeOperationsBoxHighlight() { const box = document.getElementById("operationsBox"); if(box) box.classList.remove('operations-box-active'); }

        function updateCircleVisualization(act, prev) {
            const svg = document.querySelector("#hexatonicCircle svg"); if(!svg) return; svg.innerHTML = "";
            const title = document.getElementById("circleTitle");
            if(title) title.textContent = currentVisualizationMode === 'lp' ? "Visualización (Ciclo L/P)" : "Visualización (Ciclo R/N)";
            const cycle = (currentVisualizationMode==='rn'?weitzmannCycles:hexatonicCycles).find(c => c.members.some(m => m.hasSamePitchClasses(act) && m.type===act.type));
            if(!cycle) return;
            const cx = 150, cy = 150, r = 120;
            const drawArrow = (x1,y1,x2,y2) => {
                const angle = Math.atan2(y2-y1,x2-x1); const startX=x1+30*Math.cos(angle), startY=y1+15*Math.sin(angle), endX=x2-30*Math.cos(angle), endY=y2-15*Math.sin(angle);
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path"); path.setAttribute("d", `M ${startX} ${startY} L ${endX} ${endY}`); path.setAttribute("class", `arrow`); svg.appendChild(path);
            };
            cycle.members.forEach((m, i) => {
                const ang = (i * 60 - 90) * Math.PI / 180;
                const x = cx + r * Math.cos(ang), y = cy + r * Math.sin(ang);
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", x-30); rect.setAttribute("y", y-15); rect.setAttribute("width", 60); rect.setAttribute("height", 30);
                rect.setAttribute("rx", 5); rect.setAttribute("fill", (act && m.hasSamePitchClasses(act) && m.type===act.type) ? "#3b82f6" : "#e2e8f0");
                const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                txt.setAttribute("x", x); txt.setAttribute("y", y+5); txt.setAttribute("text-anchor", "middle");
                txt.setAttribute("fill", (act && m.hasSamePitchClasses(act) && m.type===act.type) ? "white" : "#334155");
                txt.textContent = getPreferredSpelling(m).name.replace(" Mayor","").replace(" menor","m");
                g.appendChild(rect); g.appendChild(txt); svg.appendChild(g);
                
                const nextIdx = (i + 1) % 6;
                const nextAng = (nextIdx * 60 - 90) * Math.PI / 180;
                drawArrow(x, y, cx + r * Math.cos(nextAng), cy + r * Math.sin(nextAng));
            });
        }
        function drawFullTonnetz() {
            const svg = getElement("tonnetzVisualization"); if(!svg) return; svg.innerHTML = "";
            const svgNS = "http://www.w3.org/2000/svg";
            const mainSvg = document.createElementNS(svgNS, "svg"); mainSvg.setAttribute("width", "100%"); mainSvg.setAttribute("height", "100%");
            const coordToNodeMap = new Map();
            tonnetzNodesData.forEach(node => coordToNodeMap.set(`${node.x},${node.y}`, node));
            const makeLine = (x1,y1,x2,y2) => { const l = document.createElementNS(svgNS, "line"); l.setAttribute("x1",x1); l.setAttribute("y1",y1); l.setAttribute("x2",x2); l.setAttribute("y2",y2); l.setAttribute("stroke","#cbd5e1"); mainSvg.appendChild(l); };
            // Updated spacing constants for line drawing
            const P5X = 80, THY = 75, THX = 40;
            tonnetzNodesData.forEach(n => { 
                if(coordToNodeMap.has(`${n.x+P5X},${n.y}`)) makeLine(n.x,n.y,n.x+P5X,n.y); 
                if(coordToNodeMap.has(`${n.x+THX},${n.y-THY}`)) makeLine(n.x,n.y,n.x+THX,n.y-THY); 
                if(coordToNodeMap.has(`${n.x-THX},${n.y-THY}`)) makeLine(n.x,n.y,n.x-THX,n.y-THY); 
            });
            tonnetzNodesData.forEach(n => {
                const g = document.createElementNS(svgNS, "g"); g.setAttribute("transform", `translate(${n.x},${n.y})`); g.classList.add("tonnetz-node-group"); g.dataset.pc = n.pc;
                const c = document.createElementNS(svgNS, "circle"); c.setAttribute("r", 15); c.classList.add("tonnetz-node-circle"); c.setAttribute("fill","#e2e8f0"); c.setAttribute("stroke","#94a3b8");
                const t = document.createElementNS(svgNS, "text"); t.textContent = n.note; t.setAttribute("text-anchor","middle"); t.setAttribute("y",5); t.classList.add("tonnetz-node-text"); t.setAttribute("fill","#475569"); t.setAttribute("font-size","10");
                g.appendChild(c); g.appendChild(t); mainSvg.appendChild(g);
            });
            let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
            tonnetzNodesData.forEach(n=>{ minX=Math.min(minX,n.x); minY=Math.min(minY,n.y); maxX=Math.max(maxX,n.x); maxY=Math.max(maxY,n.y); });
            mainSvg.setAttribute("viewBox", `${minX-40} ${minY-40} ${maxX-minX+80} ${maxY-minY+80}`);
            svg.appendChild(mainSvg);
        }
        function highlightTonnetzTriad(triad, prev) {
            const svg = document.querySelector("#tonnetzVisualization svg"); if(!svg || !triad) return;
            svg.querySelectorAll(".tonnetz-node-circle").forEach(c=>{c.setAttribute("fill","#e2e8f0"); c.setAttribute("stroke","#94a3b8"); c.setAttribute("stroke-width","1");});
            svg.querySelectorAll(".tonnetz-node-text").forEach(t=>{t.setAttribute("fill","#475569"); t.style.fontWeight="normal";});
            const drawTri = (t, color) => {
                const nodes = Array.from(svg.querySelectorAll(".tonnetz-node-group")).filter(g=>t.pitchClasses.includes(parseInt(g.dataset.pc)));
                nodes.forEach(g=>{ g.querySelector("circle").setAttribute("fill", color); g.querySelector("circle").setAttribute("stroke-width", "2"); g.querySelector("text").setAttribute("fill", "white"); g.querySelector("text").style.fontWeight="bold"; });
            };
            if(prev) drawTri(prev, "#94a3b8"); drawTri(triad, "#3b82f6");
        }
        function highlightTonnetzByNote(pc) {
            const svg = document.querySelector("#tonnetzVisualization svg"); if (!svg) return;
            svg.querySelectorAll(".tonnetz-node-circle").forEach(c => { c.setAttribute("fill", "#e2e8f0"); c.setAttribute("stroke", "#94a3b8"); c.setAttribute("stroke-width", "1"); });
            svg.querySelectorAll(".tonnetz-node-text").forEach(t => { t.setAttribute("fill", "#475569"); t.style.fontWeight = "normal"; });
            const targetGroups = Array.from(svg.querySelectorAll(".tonnetz-node-group")).filter(g => parseInt(g.dataset.pc) === pc);
            targetGroups.forEach(g => { g.querySelector("circle").setAttribute("fill", "#facc15"); g.querySelector("circle").setAttribute("stroke", "#eab308"); g.querySelector("text").setAttribute("fill", "#422006"); g.querySelector("text").style.fontWeight = "bold"; });
            const triads = allTriads.filter(t => t.pitchClasses.includes(pc));
            triads.forEach(t => {
                const nodesToHighlight = t.pitchClasses;
                const groups = Array.from(svg.querySelectorAll(".tonnetz-node-group")).filter(g => nodesToHighlight.includes(parseInt(g.dataset.pc)));
                groups.forEach(g => { if (parseInt(g.dataset.pc) !== pc) { g.querySelector("circle").setAttribute("fill", "#bfdbfe"); g.querySelector("circle").setAttribute("stroke", "#3b82f6"); } });
            });
        }

        window.onload = () => {
            generateAllTriads(); genCycles(); populateStartChordSelect();
            setStartChord("C Mayor"); drawFullTonnetz();
            const sc = getElement("startChord"); if(sc) sc.addEventListener('change', (e)=>setStartChord(e.target.value));
            const et = getElement("enharmonicToggle"); if(et) et.addEventListener('change', (e)=>{ enharmonicPreference = e.target.checked ? 'flat' : 'sharp'; generateAllTriads(); genCycles(); populateStartChordSelect(); if(isInAnalysisMode) loadAnalysisStep(currentAnalysisStep); else setStartChord(sc.value, true); });
            const eta = getElement("enharmonicToggleAnalysis"); if(eta) eta.addEventListener('change', (e)=>{ enharmonicPreference = e.target.checked ? 'flat' : 'sharp'; document.getElementById("enharmonicToggle").checked=e.target.checked; generateAllTriads(); genCycles(); populateStartChordSelect(); if(isInAnalysisMode) loadAnalysisStep(currentAnalysisStep); else setStartChord(sc.value, true); });
            document.querySelectorAll('#operationsBox button').forEach(b => b.addEventListener('click', (e) => {
                if(isInAnalysisMode) return;
                const op = e.target.dataset.op;
                let n; if(op==='L')n=opL(currentTriad); else if(op==='P')n=opP(currentTriad); else if(op==='R')n=opR(currentTriad); else if(op==='N')n=opN(currentTriad); else if(op==='H')n=opH(currentTriad); else if(op==='S')n=opS(currentTriad);
                if(n) { const fM = lastPlayedVoicing.map(x=>Tone.Frequency(x).toMidi()); const tM = getClosestVoicing(fM, n); updateVoicing(tM); const p = currentTriad; currentTriad = n; addHistoryEntry(op, p, n, fM, tM); updateUI(); displayOperationExplanation(op, p, n, fM, tM); }
            }));
            const as = getElement("analysisSelect"); if(as) as.addEventListener('change', (e) => { if(e.target.value) startAnalysis(e.target.value); else exitAnalysis(); });
            const eb = getElement("exitAnalysisBtn"); if(eb) eb.onclick = exitAnalysis;
            const nb = getElement("nextStepBtn"); if(nb) nb.onclick = () => loadAnalysisStep(currentAnalysisStep+1);
            const pb = getElement("prevStepBtn"); if(pb) pb.onclick = () => loadAnalysisStep(currentAnalysisStep-1);
            const gb = getElement("glossaryButton"); if(gb) gb.onclick = () => safeClassListAdd("glossaryModal", "show");
            const cb = getElement("closeGlossaryButton"); if(cb) cb.onclick = () => safeClassListRemove("glossaryModal", "show");
            const am = getElement("authorModal"); if(am) { safeClassListAdd("authorModal", "show"); setTimeout(()=>safeClassListRemove("authorModal","show"), 4000); }
            document.querySelectorAll('.tab-btn').forEach(b => b.onclick = (e) => { document.querySelectorAll('.tab-btn').forEach(t=>t.classList.remove('active')); e.target.classList.add('active'); document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active')); const target = getElement(`tab${e.target.dataset.tab.charAt(0).toUpperCase()+e.target.dataset.tab.slice(1)}`); if(target) target.classList.add('active'); });
            const opCont = getElement("glossaryOperationsContainer"); if(opCont) opCont.innerHTML = Object.keys(explanations).map(k=>`<p>${explanations[k]}</p>`).join("");
            const pcb = getElement("playChordButton"); if(pcb) pcb.onclick = () => playVoicing(lastPlayedVoicing.map(x=>Tone.Frequency(x).toMidi()));
            const pab = getElement("playArpeggioButton"); if(pab) pab.onclick = () => playArpeggio(lastPlayedVoicing.map(x=>Tone.Frequency(x).toMidi()));
            const mb = getElement("muteButton"); if(mb) mb.onclick = () => { isMuted = !isMuted; mb.classList.toggle("bg-red-300"); };
            const ws = getElement("waveTypeSelect"); if(ws) ws.onchange = (e) => { synth.set({oscillator:{type:e.target.value}}); arpeggioSynth.set({oscillator:{type:e.target.value}}); };
            const vs = getElement("volumeSlider"); if(vs) vs.oninput = (e) => Tone.Destination.volume.rampTo(parseFloat(e.target.value), 0.1);
            const vt = getElement("vizToggle"); if(vt) vt.addEventListener('change', (e) => { currentVisualizationMode = e.target.checked ? 'rn' : 'lp'; updateCircleVisualization(currentTriad, previousTriad); });
            const vtc = document.querySelector('.viz-tab-container'); if(vtc) vtc.addEventListener('click', (e) => { if(e.target.classList.contains('viz-tab-btn')) { document.querySelectorAll('.viz-tab-btn').forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); document.querySelectorAll('.viz-pane').forEach(p=>p.classList.remove('active')); const p = getElement(`vizPane${e.target.dataset.viz.charAt(0).toUpperCase()+e.target.dataset.viz.slice(1)}`); if(p) p.classList.add('active'); } });
            const fab = getElement("freeAnalysisButton"); if(fab) fab.onclick = () => { const txt = getElement("freeAnalysisInput").value; const names = txt.split(",").map(s=>s.trim()).filter(s=>s); if(names.length < 2) return; exitAnalysis(); history=[]; currentHistoryIndex=-1; startAudioContext(); const t1 = getTriadByName(names[0]); if(!t1) return; currentTriad = t1; updateVoicing(t1.getNotes().map(n=>Tone.Frequency(n.replace('♯','#').replace('♭','b')+"4").toMidi())); updateUI(); let curr = t1, cmidi = lastPlayedVoicing.map(x=>Tone.Frequency(x).toMidi()); for(let i=1; i<names.length; i++){ const next = getTriadByName(names[i]); if(!next) continue; const op = findBestOperation(curr, next); const tMidi = getClosestVoicing(cmidi, next); addHistoryEntry(op, curr, next, cmidi, tMidi); curr = next; cmidi = tMidi; } currentTriad = curr; updateVoicing(cmidi); updateUI(); };
            const ccn = getElement("currentChordNotes"); if(ccn) ccn.onclick = (e) => toggleEnharmonicSpan(e.target);
            const oe = getElement("operationExplanation"); if(oe) oe.onclick = (e) => { if(!e.target.closest('button')) toggleEnharmonicSpan(e.target); };
            
            const tonnetzVis = document.getElementById("tonnetzVisualization");
            if (tonnetzVis) {
                tonnetzVis.addEventListener('click', (e) => {
                    const g = e.target.closest('.tonnetz-node-group');
                    if (!g) {
                        if (currentTonnetzHighlight !== null) {
                            currentTonnetzHighlight = null;
                            highlightTonnetzTriad(currentTriad, previousTriad);
                        }
                        return;
                    }
                    const pc = parseInt(g.dataset.pc);
                    if (isNaN(pc)) return;
                    
                    if (currentTonnetzHighlight === pc) {
                        currentTonnetzHighlight = null;
                        highlightTonnetzTriad(currentTriad, previousTriad);
                    } else {
                        currentTonnetzHighlight = pc;
                        highlightTonnetzByNote(pc);
                    }
                });
            }

            document.addEventListener('keydown', (e) => { if(e.target.tagName==='TEXTAREA' || e.target.tagName==='INPUT') return; const k = e.key.toUpperCase(); if(['L','P','R','N','H','S'].includes(k)) { const b=document.querySelector(`button[data-op="${k}"]`); if(b) b.click(); } if(e.code==='Space') { e.preventDefault(); if(pcb) pcb.click(); } if(k==='A') if(pab) pab.click(); if((k==='Z'||e.key==='Backspace') && history.length>0) { if(isInAnalysisMode) { const pb=getElement("prevStepBtn"); if(pb && !pb.disabled) pb.click(); } else if(currentHistoryIndex>0) document.querySelectorAll('.history-item')[history.length-currentHistoryIndex].click(); } });
        };
    </script>
</body>
</html>
